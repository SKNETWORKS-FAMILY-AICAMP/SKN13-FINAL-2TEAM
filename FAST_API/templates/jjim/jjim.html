{% extends "base.html" %}

{% block head %}
{% endblock %}

{% block content %}
<div class="jjim-page-container">

    <!-- 왼쪽: 상품 비교 영역 -->
    <div class="comparison-area">
        <div class="comparison-slots-container">
            <div class="comparison-slot" data-slot-id="1"><span>상품 1을 선택하세요</span></div>
            <div class="comparison-slot" data-slot-id="2"><span>상품 2를 선택하세요</span></div>
        </div>
        <div class="compare-button-container">
            <button class="compare-button">비교하기</button>
        </div>
    </div>

    <!-- 오른쪽: 찜 목록 사이드바 -->
    <aside class="wishlist-sidebar">
        <h2>찜 목록</h2>
        <div class="jjim-actions">
            <label class="select-all-label">
                <input type="checkbox" id="selectAllCheckbox"> 전체 선택
            </label>
            <button class="delete-selected-btn" id="deleteSelectedBtn">선택 삭제</button>
        </div>
        <div class="product-grid" id="jjimGrid">
            {% for product in jjim_products %}
            <div class="jjim-product-card" data-product-id="{{ product['상품ID'] }}">
                <input type="checkbox" class="jjim-product-checkbox" data-product-id="{{ product['상품ID'] }}">
                
                <img src="{{ product.get('사진') or product.get('대표이미지URL', 'https://via.placeholder.com/150') }}" alt="{{ product['상품명'] }}">
                <!-- Hidden details for JS -->
                <div class="product-details"
                     data-name="{{ product.get('제품이름', '이름 없음') }}"
                     data-brand="{{ product.get('브랜드', '정보 없음') }}"
                     data-price="{{ product.get('가격', '정보 없음') }}"
                     data-rating="{{ product.get('평점', 0) | round(1) }}"
                     data-material="{{ product.get('제품소재', '정보 없음') }}"
                     data-description="{{ product.get('description', '설명 없음') }}"
                     data-product-link="{{ product.get('상품링크', '#') }}"> <!-- Added productLink -->
                </div>
            </div>
            {% endfor %}
        </div>
    </aside>

</div>

<!-- 비교 팝업 (Modal) -->
<div class="modal-overlay">
    <div class="modal-content">
        <button class="modal-close-btn">&times;</button>
        <!-- 팝업 내용은 JS로 채워집니다 -->
    </div>
</div>

<script>
document.addEventListener("DOMContentLoaded", () => {
    // GSAP는 버튼과 모달 애니메이션에만 사용됩니다.

    const wishlistGrid = document.querySelector(".product-grid");
    const slots = gsap.utils.toArray(".comparison-slot");
    const compareBtn = document.querySelector(".compare-button");
    const modalOverlay = document.querySelector(".modal-overlay");
    const modalContainer = document.querySelector(".modal-content");

    // --- 상태 관리 ---
    function updateCompareButton() {
        const filledSlots = slots.filter(slot => slot.querySelector('.jjim-product-card')).length;
        gsap.to(compareBtn, {
            className: "compare-button" + (filledSlots === 2 ? " visible" : ""),
            duration: 0.4,
            ease: "back.out(1.7)"
        });
    }

    // --- 카드 이동 로직 (애니메이션 없음) ---
    function moveCard(card) {
        const isFromWishlist = card.parentElement.classList.contains('product-grid');

        if (isFromWishlist) {
            const emptySlot = slots.find(slot => !slot.querySelector('.jjim-product-card'));
            if (emptySlot) {
                emptySlot.innerHTML = ''; // placeholder 제거
                
                // 카드를 복제하고 이름 정보 추가
                const cardClone = card.cloneNode(true);
                const details = cardClone.querySelector('.product-details');
                const productName = details ? details.dataset.name : '상품명 없음';
                
                // 카드에 이름 정보 div 추가
                const nameDiv = document.createElement('div');
                nameDiv.className = 'product-card-info';
                nameDiv.innerHTML = `<h3>${productName}</h3>`;
                cardClone.appendChild(nameDiv);
                
                emptySlot.appendChild(cardClone);
                emptySlot.classList.add('filled');
                
                // 원본 카드는 wishlist에서 제거
                card.remove();
            }
        } else {
            const parentSlot = card.parentElement;
            
            // 카드를 다시 wishlist로 이동할 때는 이름 정보 제거
            const cardClone = card.cloneNode(true);
            const nameInfo = cardClone.querySelector('.product-card-info');
            if (nameInfo) {
                nameInfo.remove();
            }
            
            wishlistGrid.appendChild(cardClone);
            parentSlot.classList.remove('filled');
            parentSlot.innerHTML = `<span>상품 ${parentSlot.dataset.slotId}을 선택하세요</span>`;
        }
        
        updateCompareButton(); // 즉시 상태 업데이트
    }

    // --- 통합 클릭 리스너 ---
    document.querySelector('.jjim-page-container').addEventListener('click', e => {
        const card = e.target.closest('.jjim-product-card');
        if (card) {
            moveCard(card);
        }
    });

    // --- 모달 제어 ---
    function showModal() {
        const productsInSlots = slots.map(slot => slot.querySelector('.jjim-product-card'));
        if (productsInSlots.some(p => !p)) return;

        // 데이터 추출 (숨겨진 div의 data-* 속성에서)
        const productsData = productsInSlots.map(card => {
            const details = card.querySelector('.product-details');
            return {
                id: card.dataset.productId,
                img: card.querySelector('img').src,
                name: details.dataset.name,
                brand: details.dataset.brand,
                price: details.dataset.price,
                rating: details.dataset.rating,
                material: details.dataset.material,
                description: details.dataset.description,
                productLink: details.dataset.productLink // Added productLink
            };
        });

        // 비교 테이블 HTML 생성
        const tableHtml = `
            <button class="close-button" aria-label="Close modal">
                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-x"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg>
            </button>
            <h2 class="modal-title">상품 비교</h2>
            <table class="comparison-table-modal">
                <thead>
                    <tr>
                        <th></th> <!-- Empty cell for attribute labels -->
                        ${productsData.map(p => `
                            <th>
                                <img src="${p.img}" alt="${p.name}">
                            </th>
                        `).join('')}
                    </tr>
                </thead>
                <tbody>
                    <tr>
                        <td class="attribute-label">이름</td>
                        ${productsData.map(p => `<td>${p.name}</td>`).join('')}
                    </tr>
                    <tr>
                        <td class="attribute-label">브랜드</td>
                        ${productsData.map(p => `<td>${p.brand || '브랜드 정보 없음'}</td>`).join('')}
                    </tr>
                    <tr>
                        <td class="attribute-label">가격</td>
                        ${productsData.map(p => `<td class="price-cell">${p.price}</td>`).join('')}
                    </tr>
                </tbody>
            </table>
        `;

        modalContainer.innerHTML = tableHtml;
        modalOverlay.classList.add('visible');
        
        // 새로 생긴 닫기 버튼에 이벤트 리스너 다시 할당
        modalContainer.querySelector('.close-button').addEventListener('click', hideModal);
    }

    function hideModal() {
        modalOverlay.classList.remove('visible');
    }

    compareBtn.addEventListener("click", showModal);
    
    modalOverlay.addEventListener("click", (e) => {
        if (e.target === modalOverlay) {
            hideModal();
        }
    });

    // --- 삭제 기능 ---
    const selectAllCheckbox = document.getElementById('selectAllCheckbox');
    const productCheckboxes = document.querySelectorAll('.jjim-product-checkbox');
    const deleteSelectedBtn = document.getElementById('deleteSelectedBtn');
    const jjimGrid = document.getElementById('jjimGrid');

    function updateSelectAllCheckbox() {
        const allChecked = Array.from(productCheckboxes).every(checkbox => checkbox.checked);
        selectAllCheckbox.checked = allChecked;
    }

    selectAllCheckbox.addEventListener('change', () => {
        productCheckboxes.forEach(checkbox => {
            checkbox.checked = selectAllCheckbox.checked;
        });
    });

    productCheckboxes.forEach(checkbox => {
        checkbox.addEventListener('change', updateSelectAllCheckbox);
    });

    deleteSelectedBtn.addEventListener('click', async () => {
        const selectedProductIds = Array.from(productCheckboxes)
            .filter(checkbox => checkbox.checked)
            .map(checkbox => checkbox.dataset.productId);

        if (selectedProductIds.length === 0) {
            alert('삭제할 상품을 선택해주세요.');
            return;
        }

        if (!confirm(`선택된 상품 ${selectedProductIds.length}개를 정말 삭제하시겠습니까?`)) {
            return;
        }

        try {
            const formData = new FormData();
            formData.append('product_ids', selectedProductIds.join(','));

            const response = await fetch('/jjim/delete', {
                method: 'POST',
                body: formData
            });

            const result = await response.json();

            if (result.success) {
                alert(`${result.deleted_count}개의 상품이 삭제되었습니다.`);
                // 삭제된 상품들을 DOM에서 제거
                selectedProductIds.forEach(id => {
                    const cardToRemove = document.querySelector(`.jjim-product-card[data-product-id="${id}"]`);
                    if (cardToRemove) {
                        cardToRemove.remove();
                    }
                });
                // 체크박스 상태 초기화
                selectAllCheckbox.checked = false;
                updateSelectAllCheckbox(); // 혹시 모를 경우를 대비해 다시 호출
            } else {
                alert(`상품 삭제 실패: ${result.message}`);
            }
        } catch (error) {
            console.error('Error deleting products:', error);
            alert('상품 삭제 중 오류가 발생했습니다.');
        }
    });
});
</script>
{% endblock %}
