{% extends "base.html" %}

{% block head %}
<link rel="stylesheet" href="{{ url_for('static', path='css/mypage.css') }}">
<style>
  /* GSAP 애니메이션을 위한 초기 상태 설정 */
  .profile-card, .section-title, .product-card {
    opacity: 0;
    transform: translateY(30px);
  }
</style>
{% endblock %}

{% block content %}
<div class="mypage-dashboard">
  <!-- 내 정보 섹션 -->
  <section class="profile-section">
    <div class="profile-card">
      <img src="https://i.namu.wiki/i/63SUjoeSkbefiyy1x19TThehoFExxifYSYHERHsI6YVWv2yCg1e4TnR7cqKmOUFDyeqsuW27d8gK6gyrJ3LPTQ.webp" alt="Profile Picture" class="profile-picture">
      <div class="profile-info">
        <h1 class="username">{{ request.session.get('user_name', 'GUEST') }}</h1>
        <p class="userid">@{{ request.session.get('user_id', 'guest_user') }}</p>
        <div class="profile-actions">
          <button class="edit-profile-btn" id="openEditProfile">프로필 수정</button>
          <a href="/auth/logout" class="logout-btn">로그아웃</a>
        </div>
      </div>
    </div>
  </section>

  <!-- 활동 기록 섹션 -->
  <div class="activity-grid">
    <!-- 최근 본 상품 -->
    <section class="activity-section">
      <h2 class="section-title">최근 본 상품</h2>
      {% if viewed_products %}
      <div class="product-grid">
        {% for product in viewed_products %}
        <div class="product-card">
          <img src="{{ product.get('사진') or product.get('대표이미지URL', 'https://via.placeholder.com/150') }}" alt="{{ product.get('제품이름') }}">
          <p class="product-name">{{ product.get('제품이름') }}</p>
        </div>
        {% endfor %}
      </div>
      {% else %}
      <p class="no-records-message">최근 본 상품 기록이 없습니다.</p>
      {% endif %}
    </section>

    <!-- 추천 상품 -->
    <section class="activity-section">
      <h2 class="section-title">회원님을 위한 추천</h2>
      {% if recommended_products %}
      <div class="product-grid">
        {% for product in recommended_products %}
        <div class="product-card">
          <img src="{{ product.get('사진') or product.get('대표이미지URL', 'https://via.placeholder.com/150') }}" alt="{{ product.get('제품이름') }}">
          <p class="product-name">{{ product.get('제품이름') }}</p>
        </div>
        {% endfor %}
      </div>
      {% else %}
      <p class="no-records-message">추천 상품 기록이 없습니다.</p>
      {% endif %}
    </section>

    <!-- 찜한 상품 -->
    <section class="activity-section">
      <h2 class="section-title">내가 찜한 상품</h2>
      {% if jjim_products %}
      <form id="mypageJjimForm" style="margin-bottom:8px; display:flex; gap:8px; align-items:center;">
        <button type="button" id="mypageBulkDeleteBtn">선택 삭제</button>
        <label><input type="checkbox" id="mypageSelectAll"> 전체 선택</label>
      </form>
      <div class="product-grid" id="jjim-grid" style="overflow-x:auto; white-space:nowrap; gap:12px; display:flex;">
        {% for product in jjim_products %}
        <div class="product-card" data-product-id="{{ product.get('상품ID') }}" style="display:inline-block; min-width:180px; position:relative;">
          <label style="position:absolute; top:6px; left:6px; background:#fff; padding:2px 4px; border-radius:4px;">
            <input type="checkbox" class="mypage-select-item">
          </label>
          <img src="{{ product.get('사진') or product.get('대표이미지URL', 'https://via.placeholder.com/150') }}" alt="{{ product.get('제품이름') }}">
          <p class="product-name">{{ product.get('제품이름') }}</p>
        </div>
        {% endfor %}
      </div>
      {% else %}
      <p class="no-records-message">찜한 상품 기록이 없습니다.</p>
      {% endif %}
    </section>
  </div>
</div>

<script>
document.addEventListener("DOMContentLoaded", () => {
    // --- 전체 타임라인 설정 ---
    const masterTimeline = gsap.timeline({
        defaults: { ease: "power3.out", duration: 0.8 }
    });

    // 1. 프로필 섹션 등장
    masterTimeline.to(".profile-card", {
        opacity: 1,
        y: 0,
        duration: 1
    });

    // 2. 각 활동 섹션 순차적 등장
    const sections = document.querySelectorAll(".activity-section");
    sections.forEach(section => {
        const sectionTitle = section.querySelector(".section-title");
        const productCards = section.querySelectorAll(".product-card");

        masterTimeline
            .to(sectionTitle, { opacity: 1, y: 0, duration: 0.7 }, "-=.6") // 이전 애니메이션과 살짝 겹치게
            .to(productCards, {
                opacity: 1,
                y: 0,
                stagger: 0.08, // 0.08초 간격으로 순차 등장
                duration: 0.5
            }, "-=0.5");
    });

    // --- 카드 호버 효과 ---
    const cards = document.querySelectorAll(".product-card");
    cards.forEach(card => {
        gsap.set(card, { transformOrigin: "center center" });
        card.addEventListener("mouseenter", () => {
            gsap.to(card, {
                duration: 0.3,
                y: -8,
                boxShadow: "0 12px 24px rgba(0,0,0,0.15)",
                ease: "power2.out"
            });
        });
        card.addEventListener("mouseleave", () => {
            gsap.to(card, {
                duration: 0.3,
                y: 0,
                boxShadow: "0 2px 8px rgba(0,0,0,0.07)",
                ease: "power2.out"
            });
        });
    });
  // 프로필 수정 모달
  const modalHtml = `
  <div id="profileModal" class="modal" style="position:fixed; inset:0; background:rgba(0,0,0,0.5); display:none; align-items:center; justify-content:center; z-index:1000;">
    <div style="background:#fff; padding:20px; width:360px; border-radius:8px; max-height:90vh; overflow:auto;">
      <h3 style="margin-top:0;">프로필 수정</h3>
      <form id="profileForm">
        <div style="display:flex; flex-direction:column; gap:10px;">
          <input type="email" name="email" placeholder="이메일"/>
          <select name="gender">
            <option value="">성별(선택)</option>
            <option value="male">남성</option>
            <option value="female">여성</option>
            <option value="unisex">기타/선택안함</option>
          </select>
          <input type="number" name="height" placeholder="키(cm)" min="0"/>
          <input type="number" name="weight" placeholder="체중(kg)" min="0"/>
          <input type="text" name="preferred_color" placeholder="선호 색상"/>
          <input type="text" name="preferred_style" placeholder="선호 스타일(선택)"/>
        </div>
        <div style="margin-top:16px; display:flex; gap:8px; justify-content:flex-end;">
          <button type="button" id="closeProfileModal">취소</button>
          <button type="submit">저장</button>
        </div>
      </form>
    </div>
  </div>`;
  document.body.insertAdjacentHTML('beforeend', modalHtml);

  const profileModal = document.getElementById('profileModal');
  const openBtn = document.getElementById('openEditProfile');
  const closeBtn = document.getElementById('closeProfileModal');
  const form = document.getElementById('profileForm');

  function openModal() { profileModal.style.display = 'flex'; }
  function closeModal() { profileModal.style.display = 'none'; }

  async function loadProfile() {
    try {
      const res = await fetch('/mypage/profile/me');
      const data = await res.json();
      if (!data.success) return;
      form.email.value = data.user.email || '';
      form.gender.value = data.user.gender || '';
      form.height.value = data.preference.height || '';
      form.weight.value = data.preference.weight || '';
      form.preferred_color.value = data.preference.preferred_color || '';
      form.preferred_style.value = data.preference.preferred_style || '';
    } catch (e) { console.error(e); }
  }

  openBtn.addEventListener('click', async () => {
    await loadProfile();
    openModal();
  });
  profileModal.addEventListener('click', (e) => { if (e.target === profileModal) closeModal(); });
  document.addEventListener('click', (e) => { if (e.target && e.target.id === 'closeProfileModal') closeModal(); });

  form.addEventListener('submit', async (e) => {
    e.preventDefault();
    const formData = new FormData(form);
    try {
      const res = await fetch('/mypage/profile/update', { method: 'POST', body: formData });
      const data = await res.json();
      if (data.success) {
        alert('프로필이 저장되었습니다.');
        closeModal();
        // 화면 즉시 반영: 사용자명/표시값은 바뀌지 않지만 후속 로딩시 반영됨
      } else {
        alert(data.message || '저장에 실패했습니다.');
      }
    } catch (err) {
      console.error(err);
      alert('오류가 발생했습니다.');
    }
  });

  // 찜 삭제
  const jjimGrid = document.getElementById('jjim-grid');
  const selectAll = document.getElementById('mypageSelectAll');
  const bulkBtn = document.getElementById('mypageBulkDeleteBtn');
  selectAll?.addEventListener('change', () => {
    jjimGrid.querySelectorAll('.mypage-select-item').forEach(cb => { cb.checked = selectAll.checked; });
  });
  bulkBtn?.addEventListener('click', async () => {
    const ids = Array.from(jjimGrid.querySelectorAll('.product-card')).filter(card => card.querySelector('.mypage-select-item')?.checked).map(card => card.querySelector('.mypage-select-item') && card.getAttribute('data-product-id') || card.dataset.productId || card.getAttribute('data-product-id'));
    const clean = ids.filter(Boolean);
    if (clean.length === 0) return;
    try {
      const fd = new FormData();
      fd.append('product_ids', clean.join(','));
      const res = await fetch('/mypage/jjim/delete', { method: 'POST', body: fd });
      const data = await res.json();
      if (data.success) {
        clean.forEach(id => {
          const card = Array.from(jjimGrid.querySelectorAll('.product-card')).find(el => (el.getAttribute('data-product-id') || el.dataset.productId) === id);
          card?.remove();
        });
      } else {
        alert('삭제 실패');
      }
    } catch(err) {
      console.error(err);
      alert('오류');
    }
  });
});
</script>
{% endblock %}