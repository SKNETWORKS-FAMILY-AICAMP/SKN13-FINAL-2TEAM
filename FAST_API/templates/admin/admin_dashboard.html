{% extends "base.html" %}

{% block head %}
<link rel="stylesheet" href="{{ url_for('static', path='css/admin.css') }}">
{% endblock %}

{% block content %}
<div class="admin-container">
    <div class="admin-header">
        <h1>ğŸ”§ ê´€ë¦¬ì ëŒ€ì‹œë³´ë“œ</h1>
        <p>ì‹œìŠ¤í…œ ëª¨ë‹ˆí„°ë§ ë° ê´€ë¦¬ ë„êµ¬</p>
    </div>
    
    <!-- í†µê³„ ìš”ì•½ -->
    <div class="stats-grid">
        <div class="stat-item">
            <div class="stat-number" id="cache-count">-</div>
            <div class="stat-label">ìºì‹œ í•­ëª©</div>
        </div>
        <div class="stat-item">
            <div class="stat-number" id="s3-status">-</div>
            <div class="stat-label">S3 ìƒíƒœ</div>
        </div>
        <div class="stat-item">
            <div class="stat-number" id="system-status">ì •ìƒ</div>
            <div class="stat-label">ì‹œìŠ¤í…œ ìƒíƒœ</div>
        </div>
    </div>
    
    <!-- ìºì‹œ ê´€ë¦¬ -->
    <div class="admin-grid">
        <div class="admin-card">
            <h3>ğŸ“Š ìºì‹œ ê´€ë¦¬</h3>
            <p>ì‹œìŠ¤í…œ ìºì‹œ ìƒíƒœë¥¼ ëª¨ë‹ˆí„°ë§í•˜ê³  ê´€ë¦¬í•©ë‹ˆë‹¤.</p>
            <button class="admin-btn" onclick="getCacheInfo()">ìºì‹œ ì •ë³´ ì¡°íšŒ</button>
            <button class="admin-btn secondary" onclick="clearCache()">ì „ì²´ ìºì‹œ ì‚­ì œ</button>
            <button class="admin-btn secondary" onclick="cleanupCache()">ë§Œë£Œ ìºì‹œ ì •ë¦¬</button>
        </div>
        
        <div class="admin-card">
            <h3>â˜ï¸ S3 ë°ì´í„° ê´€ë¦¬</h3>
            <p>S3 ì—°ê²° ìƒíƒœë¥¼ í™•ì¸í•˜ê³  ë°ì´í„°ë¥¼ ìƒˆë¡œê³ ì¹¨í•©ë‹ˆë‹¤.</p>
            <button class="admin-btn" onclick="testS3Connection()">S3 ì—°ê²° í…ŒìŠ¤íŠ¸</button>
            <button class="admin-btn secondary" onclick="refreshS3Data()">ë°ì´í„° ìƒˆë¡œê³ ì¹¨</button>
            <button class="admin-btn" onclick="getS3Health()">S3 ìƒíƒœ í™•ì¸</button>
        </div>
        
        <div class="admin-card">
            <h3>ğŸ” ì‹œìŠ¤í…œ ëª¨ë‹ˆí„°ë§</h3>
            <p>ì „ì²´ ì‹œìŠ¤í…œì˜ ê±´ê°• ìƒíƒœë¥¼ í™•ì¸í•©ë‹ˆë‹¤.</p>
            <button class="admin-btn" onclick="checkSystemHealth()">ì‹œìŠ¤í…œ ìƒíƒœ í™•ì¸</button>
            <button class="admin-btn secondary" onclick="getSystemInfo()">ì‹œìŠ¤í…œ ì •ë³´</button>
        </div>
    </div>
    
    <!-- ë¡œê·¸ ì‹œê°í™” (í–¥í›„ êµ¬í˜„ ì˜ˆì •) -->
    <div class="coming-soon">
        <h3>ğŸ“ˆ ë¡œê·¸ ë°ì´í„° ì‹œê°í™”</h3>
        <p>OpenSearchë¥¼ í™œìš©í•œ ë¡œê·¸ ë°ì´í„° ë¶„ì„ ë° ì‹œê°í™” ê¸°ëŠ¥ì´ ì¤€ë¹„ ì¤‘ì…ë‹ˆë‹¤.</p>
        <p>ì˜ˆì • ê¸°ëŠ¥: ì‹¤ì‹œê°„ ë¡œê·¸ ëª¨ë‹ˆí„°ë§, ì‚¬ìš©ì í–‰ë™ ë¶„ì„, ì‹œìŠ¤í…œ ì„±ëŠ¥ ì§€í‘œ ë“±</p>
    </div>
    
    <!-- ê²°ê³¼ í‘œì‹œ ì˜ì—­ -->
    <div class="admin-card">
        <h3>ğŸ“‹ ì‹¤í–‰ ê²°ê³¼</h3>
        <div id="result-area" class="result-area">
            <p style="color: #6c757d; text-align: center; margin: 0;">ëª…ë ¹ì„ ì‹¤í–‰í•˜ë©´ ê²°ê³¼ê°€ ì—¬ê¸°ì— í‘œì‹œë©ë‹ˆë‹¤.</p>
        </div>
    </div>
</div>

<script>
// ê²°ê³¼ í‘œì‹œ í•¨ìˆ˜
function showResult(message, isError = false) {
    const resultArea = document.getElementById('result-area');
    const timestamp = new Date().toLocaleTimeString();
    const resultHtml = `
        <div class="result-item ${isError ? 'error' : 'success'}">
            <strong>${timestamp}</strong><br>
            ${message}
        </div>
    `;
    resultArea.innerHTML = resultHtml + resultArea.innerHTML;
}

// ìºì‹œ ì •ë³´ ì¡°íšŒ
async function getCacheInfo() {
    const btn = event.target;
    const originalText = btn.textContent;
    btn.innerHTML = '<span class="loading"></span> ë¡œë”©ì¤‘...';
    btn.disabled = true;
    
    try {
        const response = await fetch('/admin/api/cache/info');
        const data = await response.json();
        if (data.success) {
            showResult(`âœ… ìºì‹œ ì •ë³´ ì¡°íšŒ ì„±ê³µ: ${JSON.stringify(data.cache_info, null, 2)}`);
            // í†µê³„ ì—…ë°ì´íŠ¸
            document.getElementById('cache-count').textContent = data.cache_info.total_items || 0;
        } else {
            showResult(`âŒ ìºì‹œ ì •ë³´ ì¡°íšŒ ì‹¤íŒ¨: ${data.message}`, true);
        }
    } catch (error) {
        showResult(`âŒ ì˜¤ë¥˜ ë°œìƒ: ${error.message}`, true);
    } finally {
        btn.textContent = originalText;
        btn.disabled = false;
    }
}

// ì „ì²´ ìºì‹œ ì‚­ì œ
async function clearCache() {
    if (!confirm('ì •ë§ë¡œ ì „ì²´ ìºì‹œë¥¼ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) return;
    
    const btn = event.target;
    const originalText = btn.textContent;
    btn.innerHTML = '<span class="loading"></span> ì‚­ì œì¤‘...';
    btn.disabled = true;
    
    try {
        const response = await fetch('/admin/api/cache/clear', { method: 'POST' });
        const data = await response.json();
        if (data.success) {
            showResult(`âœ… ${data.message}`);
            document.getElementById('cache-count').textContent = '0';
        } else {
            showResult(`âŒ ìºì‹œ ì‚­ì œ ì‹¤íŒ¨: ${data.message}`, true);
        }
    } catch (error) {
        showResult(`âŒ ì˜¤ë¥˜ ë°œìƒ: ${error.message}`, true);
    } finally {
        btn.textContent = originalText;
        btn.disabled = false;
    }
}

// ë§Œë£Œ ìºì‹œ ì •ë¦¬
async function cleanupCache() {
    try {
        const response = await fetch('/admin/api/cache/cleanup', { method: 'POST' });
        const data = await response.json();
        if (data.success) {
            showResult(`âœ… ${data.message}`);
            // ìºì‹œ ì •ë³´ ìƒˆë¡œê³ ì¹¨
            getCacheInfo();
        } else {
            showResult(`âŒ ìºì‹œ ì •ë¦¬ ì‹¤íŒ¨: ${data.message}`, true);
        }
    } catch (error) {
        showResult(`âŒ ì˜¤ë¥˜ ë°œìƒ: ${error.message}`, true);
    }
}

// S3 ì—°ê²° í…ŒìŠ¤íŠ¸
async function testS3Connection() {
    try {
        const response = await fetch('/admin/api/cache/test-s3');
        const data = await response.json();
        if (data.success) {
            showResult(`âœ… S3 ì—°ê²° ì„±ê³µ: ${data.files_found}ê°œ íŒŒì¼ ë°œê²¬`);
            document.getElementById('s3-status').textContent = 'ì—°ê²°ë¨';
        } else {
            showResult(`âŒ S3 ì—°ê²° ì‹¤íŒ¨: ${data.message}`, true);
            document.getElementById('s3-status').textContent = 'ì‹¤íŒ¨';
        }
    } catch (error) {
        showResult(`âŒ ì˜¤ë¥˜ ë°œìƒ: ${error.message}`, true);
        document.getElementById('s3-status').textContent = 'ì˜¤ë¥˜';
    }
}

// S3 ë°ì´í„° ìƒˆë¡œê³ ì¹¨
async function refreshS3Data() {
    if (!confirm('S3 ë°ì´í„°ë¥¼ ìƒˆë¡œê³ ì¹¨í•˜ì‹œê² ìŠµë‹ˆê¹Œ? ì´ ì‘ì—…ì€ ì‹œê°„ì´ ê±¸ë¦´ ìˆ˜ ìˆìŠµë‹ˆë‹¤.')) return;
    
    try {
        const response = await fetch('/admin/api/cache/refresh-data', { method: 'POST' });
        const data = await response.json();
        if (data.success) {
            showResult(`âœ… ${data.message}`);
        } else {
            showResult(`âŒ ë°ì´í„° ìƒˆë¡œê³ ì¹¨ ì‹¤íŒ¨: ${data.message}`, true);
        }
    } catch (error) {
        showResult(`âŒ ì˜¤ë¥˜ ë°œìƒ: ${error.message}`, true);
    }
}

// S3 ìƒíƒœ í™•ì¸
async function getS3Health() {
    try {
        const response = await fetch('/admin/api/cache/health');
        const data = await response.json();
        if (data.success) {
            showResult(`âœ… ì‹œìŠ¤í…œ ìƒíƒœ: ${JSON.stringify(data.status, null, 2)}`);
        } else {
            showResult(`âŒ ìƒíƒœ í™•ì¸ ì‹¤íŒ¨: ${data.message}`, true);
        }
    } catch (error) {
        showResult(`âŒ ì˜¤ë¥˜ ë°œìƒ: ${error.message}`, true);
    }
}

// ì‹œìŠ¤í…œ ìƒíƒœ í™•ì¸
async function checkSystemHealth() {
    try {
        const response = await fetch('/admin/api/cache/health');
        const data = await response.json();
        if (data.success) {
            showResult(`âœ… ì‹œìŠ¤í…œì´ ì •ìƒì ìœ¼ë¡œ ì‘ë™ ì¤‘ì…ë‹ˆë‹¤.`);
            document.getElementById('system-status').textContent = 'ì •ìƒ';
        } else {
            showResult(`âŒ ì‹œìŠ¤í…œ ìƒíƒœ í™•ì¸ ì‹¤íŒ¨: ${data.message}`, true);
            document.getElementById('system-status').textContent = 'ì˜¤ë¥˜';
        }
    } catch (error) {
        showResult(`âŒ ì˜¤ë¥˜ ë°œìƒ: ${error.message}`, true);
        document.getElementById('system-status').textContent = 'ì˜¤ë¥˜';
    }
}

// ì‹œìŠ¤í…œ ì •ë³´ ì¡°íšŒ
async function getSystemInfo() {
    try {
        const response = await fetch('/admin/api/cache/health');
        const data = await response.json();
        if (data.success) {
            showResult(`ğŸ“Š ì‹œìŠ¤í…œ ì •ë³´: ${JSON.stringify(data.status, null, 2)}`);
        } else {
            showResult(`âŒ ì‹œìŠ¤í…œ ì •ë³´ ì¡°íšŒ ì‹¤íŒ¨: ${data.message}`, true);
        }
    } catch (error) {
        showResult(`âŒ ì˜¤ë¥˜ ë°œìƒ: ${error.message}`, true);
    }
}

// í˜ì´ì§€ ë¡œë“œ ì‹œ ì´ˆê¸° ìƒíƒœ í™•ì¸
window.addEventListener('load', function() {
    checkSystemHealth();
    getCacheInfo();
    testS3Connection();
});
</script>
{% endblock %}
