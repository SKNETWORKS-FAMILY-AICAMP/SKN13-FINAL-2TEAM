{% extends "base.html" %}

{% block content %}
    <div class="netflix-home">
<!-- Hero Section -->
<section class="hero-section">
<div aria-hidden="true" class="hero-blob"></div>
<div class="hero-split-left reveal">
<div class="hero-eyebrow">Personalized Outfit Engine</div>
<h1 class="hero-title">Ivle Malle</h1>
<p class="hero-sub">당신의 취향, 체형, 계절 컬러를 이해하는 AI가
        오늘 입을 이유를 디자인합니다. 한 번의 클릭으로 완성형 코디 제안.</p>

<div aria-hidden="true" class="brand-ticker">
<div class="brand-track">
<span>Casual</span><span>Street</span><span>Formal</span><span>Minimal</span><span>Ivle Malle</span><span>Casual</span><span>Street</span><span>Formal</span><span>Minimal</span><span>Ivle Malle</span>
</div>
</div>
</div>
<div class="hero-split-right reveal">
    <div class="hero-portrait-carousel">
       <img src="/static/img/룩북1.webp" alt="Lookbook 1" class="lookbook-image">
       <img src="/static/img/룩북2.webp" alt="Lookbook 2" class="lookbook-image">
       <img src="/static/img/룩북3.webp" alt="Lookbook 3" class="lookbook-image">
       <img src="/static/img/룩북4.webp" alt="Lookbook 4" class="lookbook-image">
       <img src="/static/img/룩북5.webp" alt="Lookbook 5" class="lookbook-image">
    </div>
</div>
</section>
<!-- Content Rows -->
        {% for section_title, section_items in [
            ("USER_CONTENT_TITLE", section1_items),
            ("지금 뜨는 콘텐츠", section2_items),
            ("새로 추가된 콘텐츠", section3_items)
        ] %}
        <section class="content-row">
        {% if section_title == "USER_CONTENT_TITLE" %}
            <h2>{{ request.session.user_name }}님이 좋아할 만한 콘텐츠</h2>
        {% else %}
            <h2>{{ section_title }}</h2>
        {% endif %}
<div class="scroll-container">
<div class="scroll-arrow left">❮</div>
<div class="row-posters">
                    {% for item in section_items %}
                                         <div style="position: relative; display: inline-block; cursor: pointer;" 
                          class="home-product-card" 
                          data-product-id="{{ item.get('상품코드') }}"
                          data-product-name="{{ item.get('제품이름') }}"
                          data-product-brand="{{ item.get('브랜드') or item.get('한글브랜드명') }}"
                          data-product-category="{{ item.get('대분류') }}"
                          data-product-subcategory="{{ item.get('소분류') }}"
                          data-product-color="{{ item.get('색상') }}"
                          data-product-price="{{ item.get('원가') }}"
                          data-product-image="{{ item.get('사진') }}"
                          data-product-link="{{ item.get('상품링크') }}">
                        <img alt="{{ item['제품이름'] }}" src="{{ item['사진'] }}" title="{{ item['제품이름'] }}: {{ item['브랜드'] }}"/>
                        {% if item.get('jjim_count', 0) > 0 %}
                        <div style="position: absolute; top: 10px; right: 10px; background: linear-gradient(135deg, #ff6b6b, #ee5a24); color: white; padding: 4px 8px; border-radius: 12px; font-size: 12px; font-weight: bold; display: flex; align-items: center; gap: 4px; box-shadow: 0 2px 8px rgba(0,0,0,0.3);">
                            <span style="font-size: 10px;">❤️</span>
                            <span style="font-size: 11px;">{{ item['jjim_count'] }}</span>
                        </div>
                        {% endif %}
                    </div>
                    {% endfor %}
                </div>
<div class="scroll-arrow right">❯</div>
</div>
</section>
        {% endfor %}
    </div>



<!-- Survey Modal -->
<div id="surveyModal" class="modal" style="position:fixed; inset:0; background:rgba(0,0,0,0.6); display:none; align-items:center; justify-content:center; z-index:2000;">
  <div style="background:white; color: #333; padding:30px; width:90%; max-width:450px; border-radius:12px; text-align:center; box-shadow: 0 5px 20px rgba(0,0,0,0.3);">
    <h2 style="margin-top:0; margin-bottom:15px; font-weight:600;">환영합니다!</h2>
    <p style="margin-bottom:25px; line-height:1.6;">더 정확한 추천을 위해 간단한 스타일 설문에 참여하시겠어요?</p>
    <div style="display:flex; gap:15px; justify-content:center;">
      <button id="acceptSurvey" style="padding:12px 25px; border:none; background:linear-gradient(135deg, #667eea, #764ba2); color:white; border-radius:8px; cursor:pointer; font-weight:600;">예, 설문 진행</button>
      <button id="declineSurvey" style="padding:12px 25px; border:2px solid #ccc; background:transparent; color:#555; border-radius:8px; cursor:pointer; font-weight:500;">아니오</button>
    </div>
  </div>
</div>


<!-- Product Detail Modal -->
<div id="homeProductModal" class="modal" style="position:fixed; inset:0; background:rgba(0,0,0,0.5); display:none; align-items:center; justify-content:center; z-index:1000;">
  <div style="background:#fff; padding:20px; width:90%; max-width:500px; border-radius:8px; max-height:90vh; overflow:auto;">
         <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:20px;">
       <h3 style="margin:0; color:#333; font-weight:600;">상품 상세 정보</h3>
       <button id="closeHomeProductModal" style="background:none; border:none; font-size:24px; cursor:pointer;">&times;</button>
     </div>
    <div id="homeProductDetails">
      <!-- 상품 상세 정보가 여기에 표시됩니다 -->
    </div>
  </div>
</div>

<!-- GSAP Animation Script -->
<script>
    document.addEventListener("DOMContentLoaded", function() {
        // 로고 등장 효과 (from을 사용하여 시작 상태를 정의)
        gsap.from(".logo-container .logo", {
            opacity: 0,
            y: -100, // 시작 Y 위치를 -100px로 설정
            duration: 1.2,
            ease: "power2.out",
            delay: 0.2
        });

        // Hero Section 등장 효과 (로고 등장 후 등장하도록 딜레이 추가)
        gsap.to(".hero-content", { 
            opacity: 1, 
            y: 0, 
            duration: 1.2,
            ease: "power2.out",
            delay: 0.8
        });

        // 콘텐츠 row 등장 효과
        gsap.utils.toArray(".content-row").forEach(function(section) {
            gsap.to(section, {
                scrollTrigger: {
                    trigger: section,
                    start: "top 80%",
                    end: "bottom 20%",
                    toggleActions: "play none none none"
                },
                opacity: 1,
                y: 0,
                duration: 0.8,
                ease: "power1.out"
            });
        });

        // 이미지 hover 효과
        const posters = document.querySelectorAll('.row-posters img');
        posters.forEach(img => {
            img.addEventListener('mouseenter', () => {
                gsap.to(img, { scale: 1.08, duration: 0.3 });
            });
            img.addEventListener('mouseleave', () => {
                gsap.to(img, { scale: 1.0, duration: 0.3 });
            });
        });

        // 화살표 클릭 스크롤 효과
        document.querySelectorAll('.scroll-container').forEach(container => {
            const leftArrow = container.querySelector('.scroll-arrow.left');
            const rightArrow = container.querySelector('.scroll-arrow.right');
            const posterContainer = container.querySelector('.row-posters');

            leftArrow.addEventListener('click', () => {
                gsap.to(posterContainer, {scrollTo: {x: "-=600"}, duration: 0.8, ease: "power1.out"});
            });
            rightArrow.addEventListener('click', () => {
                gsap.to(posterContainer, {scrollTo: {x: "+=600"}, duration: 0.8, ease: "power1.out"});
            });
        });

        // Hero Image Carousel Logic
        const lookbookImages = gsap.utils.toArray('.lookbook-image');
        if (lookbookImages.length > 0) {
            let currentIndex = 0;
            const intervalTime = 4000; // 4 seconds

            // Initially, set all but the first image to be hidden
            gsap.set(lookbookImages.slice(1), { autoAlpha: 0 });

            function showNextImage() {
                const lastIndex = currentIndex;
                currentIndex = (currentIndex + 1) % lookbookImages.length;

                gsap.to(lookbookImages[lastIndex], { autoAlpha: 0, duration: 1.2, ease: 'power1.inOut' });
                gsap.to(lookbookImages[currentIndex], { autoAlpha: 1, duration: 1.2, ease: 'power1.inOut' });
            }

            setInterval(showNextImage, intervalTime);
        }

        // 상품 상세 모달 기능
        const homeProductModal = document.getElementById('homeProductModal');
        const closeHomeProductBtn = document.getElementById('closeHomeProductModal');
        const homeProductDetails = document.getElementById('homeProductDetails');

        function openHomeProductModal() { 
            homeProductModal.style.display = 'flex'; 
        }
        function closeHomeProductModal() { 
            homeProductModal.style.display = 'none'; 
        }

                 function loadHomeProductDetails(productCard) {
             const productId = productCard.getAttribute('data-product-id');
             const productName = productCard.getAttribute('data-product-name');
             const productBrand = productCard.getAttribute('data-product-brand');
             const productCategory = productCard.getAttribute('data-product-category');
             const productSubcategory = productCard.getAttribute('data-product-subcategory');
             const productColor = productCard.getAttribute('data-product-color');
             const productPrice = productCard.getAttribute('data-product-price');
             const productImage = productCard.getAttribute('data-product-image');
             const productLink = productCard.getAttribute('data-product-link');

             // 가격 포맷팅 함수
             function formatPrice(price) {
                 if (!price || price === 'N/A') return 'N/A';
                 const numPrice = parseInt(price);
                 if (isNaN(numPrice)) return price;
                 return numPrice.toLocaleString('ko-KR') + '원';
             }

             homeProductDetails.innerHTML = `
                 <div style="display:flex; gap:20px; margin-bottom:20px;">
                     <img src="${productImage || 'https://via.placeholder.com/200'}" 
                          alt="${productName}" 
                          style="width:200px; height:200px; object-fit:cover; border-radius:8px;">
                     <div style="flex:1;">
                         <h4 style="margin:0 0 15px 0; color:#333; font-size:18px; font-weight:600;">${productName}</h4>
                         <div style="background:#f8f9fa; padding:15px; border-radius:8px; margin-bottom:15px;">
                             <p style="margin:8px 0; color:#333; font-size:14px;"><strong style="color:#2c3e50;">브랜드:</strong> <span style="color:#34495e;">${productBrand || 'N/A'}</span></p>
                             <p style="margin:8px 0; color:#333; font-size:14px;"><strong style="color:#2c3e50;">카테고리:</strong> <span style="color:#34495e;">${productCategory || 'N/A'} > ${productSubcategory || 'N/A'}</span></p>
                             <p style="margin:8px 0; color:#333; font-size:14px;"><strong style="color:#2c3e50;">색상:</strong> <span style="color:#34495e;">${productColor || 'N/A'}</span></p>
                             <p style="margin:8px 0; color:#333; font-size:14px;"><strong style="color:#2c3e50;">가격:</strong> <span style="color:#e74c3c; font-weight:600; font-size:16px;">${formatPrice(productPrice)}</span></p>
                         </div>
                         ${productLink ? `<a href="${productLink}" target="_blank" style="display:inline-block; margin-top:10px; padding:12px 20px; background:linear-gradient(135deg, #3498db, #2980b9); color:#fff; text-decoration:none; border-radius:6px; font-weight:600; box-shadow:0 2px 8px rgba(52,152,219,0.3); transition:all 0.3s ease;">상품 보기</a>` : ''}
                     </div>
                 </div>
             `;
         }

        // 상품 카드 클릭 이벤트
        document.addEventListener('click', (e) => {
            const productCard = e.target.closest('.home-product-card');
            if (productCard) {
                loadHomeProductDetails(productCard);
                openHomeProductModal();
            }
        });

        closeHomeProductBtn.addEventListener('click', closeHomeProductModal);
        homeProductModal.addEventListener('click', (e) => { 
            if (e.target === homeProductModal) closeHomeProductModal(); 
        });
    // --- Survey Modal Logic ---
        const showSurveyModal = {{ show_survey_modal|tojson }};
        if (showSurveyModal) {
            const surveyModal = document.getElementById('surveyModal');
            surveyModal.style.display = 'flex';

            document.getElementById('acceptSurvey').addEventListener('click', () => {
                window.location.href = '/survey/';
            });

            document.getElementById('declineSurvey').addEventListener('click', async () => {
                try {
                    const response = await fetch('/survey/decline', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        }
                    });
                    if (response.ok) {
                        surveyModal.style.display = 'none';
                    } else {
                        alert('오류가 발생했습니다. 다시 시도해주세요.');
                    }
                } catch (error) {
                    console.error('Error declining survey:', error);
                    alert('오류가 발생했습니다. 다시 시도해주세요.');
                }
            });
        }
    });

    </script>

    <script>
      // Reveal on scroll
      const io = new IntersectionObserver((entries)=>{
        entries.forEach(e=>{
          if(e.isIntersecting){ e.target.classList.add('show'); io.unobserve(e.target); }
        });
      }, {threshold: .12, rootMargin: '0px 0px -40px 0px'});
      document.querySelectorAll('.reveal, .row').forEach(el=> io.observe(el));
    </script>

{% endblock %}
