{% extends "base.html" %}

{% block head %}
<link rel="stylesheet" href="{{ url_for('static', path='css/mypage.css') }}">
<style>
  /* GSAP 애니메이션을 위한 초기 상태 설정 */
  .profile-card, .section-title, .product-card {
    opacity: 0;
    transform: translateY(30px);
  }
</style>
{% endblock %}

{% block content %}
<div class="mypage-wrapper">
  <div class="mypage-dashboard">
    <!-- 내 정보 섹션 -->
    <section class="profile-section">
      <div class="profile-card">
        <img src="https://i.namu.wiki/i/63SUjoeSkbefiyy1x19TThehoFExxifYSYHERHsI6YVWv2yCg1e4TnR7cqKmOUFDyeqsuW27d8gK6gyrJ3LPTQ.webp" alt="Profile Picture" class="profile-picture">
        <div class="profile-info">
          <h1 class="username">{{ request.session.get('user_name', 'GUEST') }}</h1>
          <p class="userid">@{{ request.session.get('user_id', 'guest_user') }}</p>
          <div class="profile-actions">
            <button class="edit-profile-btn" id="openEditProfile">프로필 수정</button>
            <a href="/survey/" class="retake-survey-btn">설문조사 다시하기</a>
            <a href="/auth/logout" class="logout-btn">로그아웃</a>
            <button class="delete-account-btn" id="deleteAccountBtn">회원탈퇴</button>
          </div>
        </div>
      </div>
    </section>

    <!-- 활동 기록 섹션 -->
    <div class="activity-grid">
      <!-- 최근 추천받은 상품 -->
      <section class="activity-section">
        <h2 class="section-title">최근 추천받은 상품</h2>
        {% if recommended_products %}
        <div class="scroll-container">
          <div class="scroll-arrow left">❮</div>
          <div class="row-posters" id="recommendation-grid">
            {% for rec in recommended_products %}
            <div class="product-card recommendation-card" 
                 data-product-id="{{ rec.product.get('상품코드') }}" 
                 data-product-name="{{ rec.product.get('제품이름') }}"
                 data-product-brand="{{ rec.product.get('브랜드') or rec.product.get('한글브랜드명') }}"
                 data-product-category="{{ rec.product.get('대분류') }}"
                 data-product-subcategory="{{ rec.product.get('소분류') }}"
                 data-product-color="{{ rec.product.get('색상') }}"
                 data-product-price="{{ rec.product.get('원가') }}"
                 data-product-image="{{ rec.product.get('사진') }}"
                 data-product-link="{{ rec.product.get('상품링크') }}"
                 data-query="{{ rec.query }}" 
                 data-reason="{{ rec.reason }}" 
                 style="cursor: pointer;">
              <img src="{{ rec.product.get('사진') or rec.product.get('대표이미지URL', 'https://via.placeholder.com/150') }}" alt="{{ rec.product.get('제품이름') }}">
              <p class="product-name">{{ rec.product.get('제품이름') }}</p>
            </div>
            {% endfor %}
          </div>
          <div class="scroll-arrow right">❯</div>
        </div>
        {% else %}
        <p class="no-records-message">아직 추천받은 상품이 없습니다.</p>
        {% endif %}
      </section>

      <!-- 찜한 상품 -->
      <section class="activity-section">
        <h2 class="section-title">내가 찜한 상품</h2>
        {% if jjim_products %}
        <form id="mypageJjimForm" style="margin-bottom:8px; display:flex; gap:8px; align-items:center;">
          <button type="button" id="mypageBulkDeleteBtn">선택 삭제</button>
          <label><input type="checkbox" id="mypageSelectAll"> 전체 선택</label>
        </form>
        <div class="scroll-container">
          <div class="scroll-arrow left">❮</div>
          <div class="row-posters" id="jjim-grid">
            {% for product in jjim_products %}
            <div class="product-card" 
                 data-product-id="{{ product.get('상품코드') }}" 
                 data-product-name="{{ product.get('제품이름') }}"
                 data-product-brand="{{ product.get('브랜드') or product.get('한글브랜드명') }}"
                 data-product-category="{{ product.get('대분류') }}"
                 data-product-subcategory="{{ product.get('소분류') }}"
                 data-product-color="{{ product.get('색상') }}"
                 data-product-price="{{ product.get('원가') }}"
                 data-product-image="{{ product.get('사진') }}"
                 data-product-link="{{ product.get('상품링크') }}"
                 style="position:relative; cursor: pointer;">
              <label style="position:absolute; top:6px; left:6px; background:#fff; padding:2px 4px; border-radius:4px; z-index:10;">
                <input type="checkbox" class="mypage-select-item">
              </label>
              <img src="{{ product.get('사진') or product.get('대표이미지URL', 'https://via.placeholder.com/150') }}" alt="{{ product.get('제품이름') }}">
              <p class="product-name">{{ product.get('제품이름') }}</p>
            </div>
            {% endfor %}
          </div>
          <div class="scroll-arrow right">❯</div>
        </div>
        {% else %}
        <p class="no-records-message">찜한 상품이 없습니다.</p>
        {% endif %}
      </section>

      <!-- 대화 내역 -->
      <section class="activity-section">
        <h2 class="section-title">대화 내역</h2>
        {% if chat_history %}
        <div class="chat-history-grid">
          {% for chat in chat_history %}
          <div class="chat-card">
            <div class="chat-header">
              <h3 class="chat-title">{{ chat.session_name }}</h3>
              <span class="chat-date">{{ chat.created_at.strftime('%m월 %d일 %H:%M') }}</span>
            </div>
            <div class="chat-content">
              <div class="chat-message-preview">
                <span class="message-label">나:</span>
                <span class="message-text">{{ chat.first_message }}</span>
              </div>
              {% if chat.last_response %}
              <div class="chat-response-preview">
                <span class="message-label">챗봇:</span>
                <span class="message-text">{{ chat.last_response }}</span>
              </div>
              {% endif %}
            </div>
            <div class="chat-footer">
              <span class="message-count">{{ chat.message_count }}개의 메시지</span>
              <button class="view-chat-btn" data-session-id="{{ chat.session_id }}">대화 보기</button>
            </div>
          </div>
          {% endfor %}
        </div>
        {% else %}
        <p class="no-records-message">아직 대화 내역이 없습니다.</p>
        {% endif %}
      </section>
    </div>
  </div>
</div>

<!-- 상품 상세 모달 -->
<div id="mypageProductModal" class="modal" style="position:fixed; inset:0; background:rgba(0,0,0,0.5); display:none; align-items:center; justify-content:center; z-index:1000;">
  <div style="background:#fff; padding:20px; width:90%; max-width:500px; border-radius:8px; max-height:90vh; overflow:auto;">
    <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:20px;">
      <h3 style="margin:0; color:#333; font-weight:600;">상품 상세 정보</h3>
      <button id="closeMypageProductModal" style="background:none; border:none; font-size:24px; cursor:pointer;">&times;</button>
    </div>
    <div id="mypageProductDetails">
      <!-- 상품 상세 정보가 여기에 표시됩니다 -->
    </div>
  </div>
</div>

<script>

document.addEventListener("DOMContentLoaded", () => {
    // --- 전체 타임라인 설정 ---
    const masterTimeline = gsap.timeline({
        defaults: { ease: "power2.out", duration: 0.3 }
    });

    // 1. 프로필 섹션 등장
    masterTimeline.to(".profile-card", {
        opacity: 1,
        y: 0,
        duration: 0.5
    });

    // 2. 각 활동 섹션 순차적 등장
    const sections = document.querySelectorAll(".activity-section");
    sections.forEach(section => {
        const sectionTitle = section.querySelector(".section-title");
        const productCards = section.querySelectorAll(".product-card");

        masterTimeline
            .to(sectionTitle, { opacity: 1, y: 0, duration: 0.3 }, "-=.2")
            .to(productCards, {
                opacity: 1,
                y: 0,
                stagger: 0.02,
                duration: 0.3
            }, "-=0.1");
    });

    // --- 카드 호버 효과 ---
    const cards = document.querySelectorAll(".product-card");
    cards.forEach(card => {
        gsap.set(card, { transformOrigin: "center center" });
        card.addEventListener("mouseenter", () => {
            gsap.to(card, {
                duration: 0.3,
                y: -8,
                boxShadow: "0 12px 24px rgba(0,0,0,0.15)",
                ease: "power2.out"
            });
        });
        card.addEventListener("mouseleave", () => {
            gsap.to(card, {
                duration: 0.3,
                y: 0,
                boxShadow: "0 2px 8px rgba(0,0,0,0.07)",
                ease: "power2.out"
            });
        });
    });

    // 상품 상세 모달 기능
    const mypageProductModal = document.getElementById('mypageProductModal');
    const closeMypageProductBtn = document.getElementById('closeMypageProductModal');
    const mypageProductDetails = document.getElementById('mypageProductDetails');

    function openMypageProductModal() { 
        mypageProductModal.style.display = 'flex'; 
    }
    function closeMypageProductModal() { 
        mypageProductModal.style.display = 'none'; 
    }

    function loadMypageProductDetails(productCard) {
        const productId = productCard.getAttribute('data-product-id');
        const productName = productCard.getAttribute('data-product-name');
        const productBrand = productCard.getAttribute('data-product-brand');
        const productCategory = productCard.getAttribute('data-product-category');
        const productSubcategory = productCard.getAttribute('data-product-subcategory');
        const productColor = productCard.getAttribute('data-product-color');
        const productPrice = productCard.getAttribute('data-product-price');
        const productImage = productCard.getAttribute('data-product-image');
        const productLink = productCard.getAttribute('data-product-link');

        // 가격 포맷팅 함수
        function formatPrice(price) {
            if (!price || price === 'N/A') return 'N/A';
            const numPrice = parseInt(price);
            if (isNaN(numPrice)) return price;
            return numPrice.toLocaleString('ko-KR') + '원';
        }

        mypageProductDetails.innerHTML = `
            <div style="display:flex; gap:20px; margin-bottom:20px;">
                <img src="${productImage || 'https://via.placeholder.com/200'}" 
                     alt="${productName}" 
                     style="width:200px; height:200px; object-fit:cover; border-radius:8px;">
                <div style="flex:1;">
                    <h4 style="margin:0 0 15px 0; color:#333; font-size:18px; font-weight:600;">${productName}</h4>
                    <div style="background:#f8f9fa; padding:15px; border-radius:8px; margin-bottom:15px;">
                        <p style="margin:8px 0; color:#333; font-size:14px;"><strong style="color:#2c3e50;">브랜드:</strong> <span style="color:#34495e;">${productBrand || 'N/A'}</span></p>
                        <p style="margin:8px 0; color:#333; font-size:14px;"><strong style="color:#2c3e50;">카테고리:</strong> <span style="color:#34495e;">${productCategory || 'N/A'} > ${productSubcategory || 'N/A'}</span></p>
                        <p style="margin:8px 0; color:#333; font-size:14px;"><strong style="color:#2c3e50;">색상:</strong> <span style="color:#34495e;">${productColor || 'N/A'}</span></p>
                        <p style="margin:8px 0; color:#333; font-size:14px;"><strong style="color:#2c3e50;">가격:</strong> <span style="color:#e74c3c; font-weight:600; font-size:16px;">${formatPrice(productPrice)}</span></p>
                    </div>
                    ${productLink ? `<a href="${productLink}" target="_blank" style="display:inline-block; margin-top:10px; padding:12px 20px; background:linear-gradient(135deg, #3498db, #2980b9); color:#fff; text-decoration:none; border-radius:6px; font-weight:600; box-shadow:0 2px 8px rgba(52,152,219,0.3); transition:all 0.3s ease;">상품 보기</a>` : ''}
                </div>
            </div>
        `;
    }

    // 상품 카드 클릭 이벤트 (추천 상품)
    const recommendationCards = document.querySelectorAll('.recommendation-card');
    recommendationCards.forEach(card => {
        card.addEventListener('click', async (e) => {
            // 체크박스 클릭 시 모달 열리지 않도록 방지
            if (e.target.type === 'checkbox' || e.target.closest('label')) {
                return;
            }
            
            console.log('추천 상품 카드 클릭됨');
            loadMypageProductDetails(card);
            openMypageProductModal();
        });
    });

    // 찜 상품 카드 클릭 이벤트
    document.addEventListener('click', (e) => {
        const productCard = e.target.closest('.product-card');
        if (productCard && productCard.closest('#jjim-grid')) {
            // 체크박스 클릭 시 모달 열리지 않도록 방지
            if (e.target.type === 'checkbox' || e.target.closest('label')) {
                return;
            }
            
            console.log('찜 상품 카드 클릭됨');
            loadMypageProductDetails(productCard);
            openMypageProductModal();
        }
    });

    // 모달 닫기 이벤트
    closeMypageProductBtn.addEventListener('click', closeMypageProductModal);
    mypageProductModal.addEventListener('click', (e) => { 
        if (e.target === mypageProductModal) closeMypageProductModal(); 
    });

    // 프로필 수정 모달
    const modalHtml = `
    <div id="profileModal" style="position:fixed; inset:0; background:rgba(0,0,0,0.5); display:none; align-items:center; justify-content:center; z-index:1000; opacity:0; transition:opacity 0.3s ease;">
      <div style="background:#fff; padding:25px; width:350px; border-radius:12px; box-shadow:0 10px 25px rgba(0,0,0,0.2); transform:scale(0.9); transition:transform 0.3s ease;">
        <h3 style="margin:0 0 20px 0; text-align:center; color:#333; font-size:18px;">프로필 수정</h3>
        <form id="profileForm">
          <div style="display:flex; flex-direction:column; gap:12px;">
            <input type="email" name="email" placeholder="이메일" style="padding:10px 12px; border:1px solid #ddd; border-radius:6px; font-size:14px; transition:border-color 0.2s;" onfocus="this.style.borderColor='#4CAF50'" onblur="this.style.borderColor='#ddd'"/>
            <select name="gender" style="padding:10px 12px; border:1px solid #ddd; border-radius:6px; font-size:14px; transition:border-color 0.2s;" onfocus="this.style.borderColor='#4CAF50'" onblur="this.style.borderColor='#ddd'">
              <option value="">성별 선택</option>
              <option value="male">남성</option>
              <option value="female">여성</option>
              <option value="unisex">기타</option>
            </select>
            <input type="number" name="height" placeholder="키(cm)" min="0" style="padding:10px 12px; border:1px solid #ddd; border-radius:6px; font-size:14px; transition:border-color 0.2s;" onfocus="this.style.borderColor='#4CAF50'" onblur="this.style.borderColor='#ddd'"/>
            <input type="number" name="weight" placeholder="체중(kg)" min="0" style="padding:10px 12px; border:1px solid #ddd; border-radius:6px; font-size:14px; transition:border-color 0.2s;" onfocus="this.style.borderColor='#4CAF50'" onblur="this.style.borderColor='#ddd'"/>
            <input type="text" name="preferred_color" placeholder="선호 색상" style="padding:10px 12px; border:1px solid #ddd; border-radius:6px; font-size:14px; transition:border-color 0.2s;" onfocus="this.style.borderColor='#4CAF50'" onblur="this.style.borderColor='#ddd'"/>
            <input type="text" name="preferred_style" placeholder="선호 스타일" style="padding:10px 12px; border:1px solid #ddd; border-radius:6px; font-size:14px; transition:border-color 0.2s;" onfocus="this.style.borderColor='#4CAF50'" onblur="this.style.borderColor='#ddd'"/>
          </div>
          <div style="margin-top:20px; display:flex; gap:10px;">
            <button type="button" id="closeProfileModal" style="flex:1; padding:10px; border:1px solid #ddd; background:#fff; color:#666; border-radius:6px; cursor:pointer; transition:all 0.2s;" onmouseover="this.style.background='#f5f5f5'" onmouseout="this.style.background='#fff'">취소</button>
            <button type="submit" style="flex:1; padding:10px; border:none; background:#4CAF50; color:white; border-radius:6px; cursor:pointer; transition:all 0.2s;" onmouseover="this.style.background='#45a049'" onmouseout="this.style.background='#4CAF50'">저장</button>
          </div>
        </form>
      </div>
    </div>`;
    document.body.insertAdjacentHTML('beforeend', modalHtml);

    const profileModal = document.getElementById('profileModal');
    const openBtn = document.getElementById('openEditProfile');
    const closeBtn = document.getElementById('closeProfileModal');
    const form = document.getElementById('profileForm');

    function openModal() { 
        profileModal.style.display = 'flex'; 
        setTimeout(() => {
            profileModal.style.opacity = '1';
            profileModal.children[0].style.transform = 'scale(1)';
        }, 10);
    }
    function closeModal() { 
        profileModal.style.opacity = '0';
        profileModal.children[0].style.transform = 'scale(0.9)';
        setTimeout(() => profileModal.style.display = 'none', 300);
    }

    async function loadProfile() {
      try {
        const res = await fetch('/mypage/profile/me');
        const data = await res.json();
        if (!data.success) return;
        form.email.value = data.user.email || '';
        form.gender.value = data.user.gender || '';
        form.height.value = data.preference.height || '';
        form.weight.value = data.preference.weight || '';
        form.preferred_color.value = data.preference.preferred_color || '';
        form.preferred_style.value = data.preference.preferred_style || '';
      } catch (e) { console.error(e); }
    }

    openBtn.addEventListener('click', async () => {
      await loadProfile();
      openModal();
    });
    profileModal.addEventListener('click', (e) => { if (e.target === profileModal) closeModal(); });
    document.addEventListener('click', (e) => { if (e.target && e.target.id === 'closeProfileModal') closeModal(); });

    form.addEventListener('submit', async (e) => {
      e.preventDefault();
      const formData = new FormData(form);
      try {
        const res = await fetch('/mypage/profile/update', { method: 'POST', body: formData });
        const data = await res.json();
        if (data.success) {
          alert('프로필이 저장되었습니다.');
          closeModal();
        } else {
          alert(data.message || '저장에 실패했습니다.');
        }
      } catch (err) {
        console.error(err);
        alert('오류가 발생했습니다.');
      }
    });

    // 찜 삭제
    const jjimGrid = document.getElementById('jjim-grid');
    const selectAll = document.getElementById('mypageSelectAll');
    const bulkBtn = document.getElementById('mypageBulkDeleteBtn');
    selectAll?.addEventListener('change', () => {
      jjimGrid.querySelectorAll('.mypage-select-item').forEach(cb => { cb.checked = selectAll.checked; });
    });
    bulkBtn?.addEventListener('click', async () => {
      const ids = Array.from(jjimGrid.querySelectorAll('.product-card')).filter(card => card.querySelector('.mypage-select-item')?.checked).map(card => card.querySelector('.mypage-select-item') && card.getAttribute('data-product-id') || card.dataset.productId || card.getAttribute('data-product-id'));
      const clean = ids.filter(Boolean);
      if (clean.length === 0) return;
      try {
        const fd = new FormData();
        fd.append('product_ids', clean.join(','));
        const res = await fetch('/mypage/jjim/delete', { method: 'POST', body: fd });
        const data = await res.json();
        if (data.success) {
          clean.forEach(id => {
            const card = Array.from(jjimGrid.querySelectorAll('.product-card')).find(el => (el.getAttribute('data-product-id') || el.dataset.productId) === id);
            card?.remove();
          });
        } else {
          alert('삭제 실패');
        }
      } catch(err) {
        console.error(err);
        alert('오류');
      }
    });

    // 대화 내역 모달
    const chatModalHtml = `
    <div id="chatModal" class="modal" style="position:fixed; inset:0; background:rgba(0,0,0,0.5); display:none; align-items:center; justify-content:center; z-index:1000;">
      <div style="background:#fff; padding:20px; width:90%; max-width:600px; border-radius:8px; max-height:90vh; overflow:auto;">
        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:20px;">
          <h3 style="margin:0;">대화 내역</h3>
          <button id="closeChatModal" style="background:none; border:none; font-size:24px; cursor:pointer;">&times;</button>
        </div>
        <div id="chatMessages" style="max-height:400px; overflow-y:auto; border:1px solid #ddd; padding:15px; border-radius:8px; background:#f9f9f9;">
          <!-- 대화 메시지들이 여기에 표시됩니다 -->
        </div>
      </div>
    </div>`;
    document.body.insertAdjacentHTML('beforeend', chatModalHtml);

    const chatModal = document.getElementById('chatModal');
    const closeChatBtn = document.getElementById('closeChatModal');
    const chatMessages = document.getElementById('chatMessages');

    function openChatModal() { chatModal.style.display = 'flex'; }
    function closeChatModal() { chatModal.style.display = 'none'; }

    // 대화 보기 버튼 이벤트 리스너
    document.addEventListener('click', async (e) => {
      if (e.target.classList.contains('view-chat-btn')) {
        const sessionId = e.target.getAttribute('data-session-id');
        await loadChatMessages(sessionId);
        openChatModal();
      }
    });



    // 수평 스크롤 기능 - 홈페이지와 동일한 방식
    document.querySelectorAll('.scroll-container').forEach(container => {
        const leftArrow = container.querySelector('.scroll-arrow.left');
        const rightArrow = container.querySelector('.scroll-arrow.right');
        const posters = container.querySelector('.row-posters');

        if (leftArrow && rightArrow && posters) {
            leftArrow.addEventListener('click', () => {
                // GSAP가 로드되어 있는지 확인 후 사용
                if (typeof gsap !== 'undefined' && gsap.to) {
                    gsap.to(posters, {scrollTo: {x: "-=600"}, duration: 0.8, ease: "power1.out"});
                } else {
                    // GSAP가 없으면 기본 방식 사용
                    posters.scrollBy({ left: -600, behavior: 'smooth' });
                }
            });
            
            rightArrow.addEventListener('click', () => {
                // GSAP가 로드되어 있는지 확인 후 사용
                if (typeof gsap !== 'undefined' && gsap.to) {
                    gsap.to(posters, {scrollTo: {x: "+=600"}, duration: 0.8, ease: "power1.out"});
                } else {
                    // GSAP가 없으면 기본 방식 사용
                    posters.scrollBy({ left: 600, behavior: 'smooth' });
                }
            });

            }
    });

    // 대화 보기 기능
    async function loadChatMessages(sessionId) {
      try {
        const res = await fetch(`/chat/session/${sessionId}/messages`);
        const data = await res.json();
        if (data.success && data.messages) {
          displayChatMessages(data.messages);
        } else {
          chatMessages.innerHTML = '<p style="text-align:center; color:#666;">대화 내역을 불러올 수 없습니다.</p>';
        }
      } catch (err) {
        console.error(err);
        chatMessages.innerHTML = '<p style="text-align:center; color:#666;">오류가 발생했습니다.</p>';
      }
    }

    function displayChatMessages(messages) {
      chatMessages.innerHTML = messages.map(msg => `
        <div style="margin-bottom:15px; padding:12px; border-radius:8px; ${msg.type === 'user' ? 'background:#e3f2fd; margin-left:20px; border-left:4px solid #2196f3;' : 'background:#fff; margin-right:20px; border-left:4px solid #4caf50;'}">
          <div style="font-weight:600; margin-bottom:8px; color:#333; font-size:0.9em;">
            ${msg.type === 'user' ? '나' : '챗봇'}
          </div>
          <div style="line-height:1.6; color:#555; font-size:0.95em;">
            ${msg.text}
          </div>
          <div style="font-size:0.8em; color:#999; margin-top:8px;">
            ${new Date(msg.created_at).toLocaleString('ko-KR')}
          </div>
        </div>
      `).join('');
    }

    closeChatBtn.addEventListener('click', closeChatModal);
    chatModal.addEventListener('click', (e) => { if (e.target === chatModal) closeChatModal(); });

    // 회원탈퇴 기능
    const deleteAccountBtn = document.getElementById('deleteAccountBtn');
    deleteAccountBtn?.addEventListener('click', async () => {
        if (confirm('정말로 계정을 삭제하시겠습니까? 이 작업은 되돌릴 수 없습니다.')) {
            try {
                const res = await fetch('/mypage/delete_account', { method: 'POST' });
                const data = await res.json();
                if (data.success) {
                    alert('계정이 성공적으로 삭제되었습니다.');
                    window.location.href = '/auth/login'; // 로그인 페이지로 리다이렉트
                } else {
                    alert(data.message || '계정 삭제 중 오류가 발생했습니다.');
                }
            } catch (err) {
                console.error(err);
                alert('계정 삭제 중 네트워크 오류가 발생했습니다.');
            }
        }
    });
});
</script>
{% endblock %}
