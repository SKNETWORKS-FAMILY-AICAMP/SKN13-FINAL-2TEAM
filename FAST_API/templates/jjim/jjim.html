{% extends "base.html" %}

{% block head %}
{% endblock %}

{% block content %}
<div class="jjim-page-container">

    <!-- 왼쪽: 상품 비교 영역 -->
    <div class="comparison-area">
        <div class="comparison-slots-container">
            <div class="comparison-slot" data-slot-id="1"><span>상품 1을 선택하세요</span></div>
            <div class="comparison-slot" data-slot-id="2"><span>상품 2를 선택하세요</span></div>
        </div>
        <div class="compare-button-container">
            <button class="compare-button">비교하기</button>
        </div>
    </div>

    <!-- 오른쪽: 찜 목록 사이드바 -->
    <aside class="wishlist-sidebar">
        <h2>찜 목록</h2>
        <div class="jjim-actions">
            <label class="select-all-label">
                <input type="checkbox" id="selectAllCheckbox"> 전체 선택
            </label>
            <button class="delete-selected-btn" id="deleteSelectedBtn">선택 삭제</button>
        </div>
        <div class="product-grid" id="jjimGrid">
            {% for product in jjim_products %}
            <div class="jjim-product-card" data-product-id="{{ product['상품코드'] }}">
                <input type="checkbox" class="jjim-product-checkbox" data-product-id="{{ product['상품코드'] }}">

                <img src="{{ product.get('사진') or product.get('대표이미지URL', 'https://via.placeholder.com/150') }}" alt="{{ product['상품명'] }}">
                <!-- Hidden details for JS -->
                <div class="product-details"
                     data-name="{{ product.get('상품명', '이름 없음') }}"
                     data-brand="{{ product.get('한글브랜드명', '정보 없음') }}"
                     data-price="{{ product.get('가격', '정보 없음') }}"
                     data-rating="{{ (product.get('평점') or 0) | round(1) }}"
                     data-material="{{ product.get('소재', '정보 없음') }}"
                     data-description="{{ product.get('description', '설명 없음') }}"
                     data-product-link="{{ product.get('상품링크', '#') }}"
                     data-site="{{ product.get('사이트명', '정보 없음') }}"> <!-- Added site -->
                </div>
            </div>
            {% endfor %}
        </div>
    </aside>

</div>

<!-- 비교 팝업 (Modal) -->
<div class="modal-overlay">
    <div class="modal-content">
        <button class="modal-close-btn">&times;</button>
        <!-- 팝업 내용은 JS로 채워집니다 -->
    </div>
</div>

<script>
document.addEventListener("DOMContentLoaded", () => {
    const wishlistGrid = document.querySelector(".product-grid");
    const slots = gsap.utils.toArray(".comparison-slot");
    const compareBtn = document.querySelector(".compare-button");
    const modalOverlay = document.querySelector(".modal-overlay");
    const modalContainer = document.querySelector(".modal-content");

    const selectedProductIds = new Set();

    function updateCompareButton() {
        const filledSlots = slots.filter(slot => slot.querySelector('.jjim-product-card')).length;
        gsap.to(compareBtn, {
            className: "compare-button" + (filledSlots === 2 ? " visible" : ""),
            duration: 0.4,
            ease: "back.out(1.7)"
        });
    }

    function moveCard(card) {
        const productId = card.dataset.productId;
        const isFromWishlist = card.parentElement.classList.contains('product-grid');

        console.log(`Clicked card ID: ${productId}, From Wishlist: ${isFromWishlist}`);
        console.log(`Current selectedProductIds:`, Array.from(selectedProductIds));

        if (isFromWishlist) {
            if (selectedProductIds.has(productId)) {
                console.log(`Product ${productId} already in comparison, doing nothing.`);
                return;
            }

            const emptySlot = slots.find(slot => !slot.querySelector('.jjim-product-card'));
            console.log(`Found empty slot:`, emptySlot);

            if (emptySlot) {
                emptySlot.innerHTML = '';

                const cardClone = card.cloneNode(true);
                const details = cardClone.querySelector('.product-details');
                const productName = details ? details.dataset.name : '상품명 없음';

                const imgElement = cardClone.querySelector('img');
                if (!imgElement || !imgElement.src) {
                    const defaultImg = document.createElement('img');
                    defaultImg.src = 'https://via.placeholder.com/150';
                    defaultImg.alt = productName;
                    if (imgElement) {
                        imgElement.replaceWith(defaultImg);
                    } else {
                        cardClone.insertBefore(defaultImg, cardClone.firstChild);
                    }
                }

                const nameDiv = document.createElement('div');
                nameDiv.className = 'product-card-info';
                nameDiv.innerHTML = `<h3>${productName}</h3>`;
                cardClone.appendChild(nameDiv);

                emptySlot.appendChild(cardClone);
                emptySlot.classList.add('filled');

                card.classList.add('selected-for-comparison');
                card.style.pointerEvents = 'none';

                selectedProductIds.add(productId);
                console.log(`Added ${productId} to comparison. New selectedProductIds:`, Array.from(selectedProductIds));
            }
        } else {
            console.log(`Moving ${productId} from comparison slot back to wishlist.`);
            const parentSlot = card.parentElement;

            parentSlot.classList.remove('filled');
            parentSlot.innerHTML = `<span>상품 ${parentSlot.dataset.slotId}을 선택하세요</span>`;

            const originalCard = wishlistGrid.querySelector(`.jjim-product-card[data-product-id="${productId}"]`);
            if (originalCard) {
                originalCard.classList.remove('selected-for-comparison');
                originalCard.style.pointerEvents = 'auto';
                console.log(`Original card ${productId} ungrayed and clickable.`);
            }

            selectedProductIds.delete(productId);
            console.log(`Removed ${productId} from comparison. New selectedProductIds:`, Array.from(selectedProductIds));
        }

        updateCompareButton();
    }

    document.querySelector('.jjim-page-container').addEventListener('click', e => {
        // Check if the clicked element is a checkbox
        if (e.target.classList.contains('jjim-product-checkbox')) {
            // Stop event propagation to prevent the parent card's click listener from firing
            e.stopPropagation();
            return; // Exit the function as we've handled the checkbox click
        }

        const card = e.target.closest('.jjim-product-card');
        if (card) {
            if (card.style.pointerEvents !== 'none' || !card.parentElement.classList.contains('product-grid')) {
                moveCard(card);
            }
        }
    });

    function showModal() {
        const productsInSlots = slots.map(slot => slot.querySelector('.jjim-product-card'));
        if (productsInSlots.some(p => !p)) {
            alert("비교할 상품 두 개를 모두 선택해주세요."); // Alert if not enough products
            return;
        }

        const productsData = productsInSlots.map(card => {
            const details = card.querySelector('.product-details');
            const imgElement = card.querySelector('img');

            const imgSrc = imgElement && imgElement.src ? imgElement.src : 'https://via.placeholder.com/150';

            return {
                id: card.dataset.productId,
                img: imgSrc,
                name: details ? details.dataset.name : '상품명 없음',
                brand: details ? details.dataset.brand : '브랜드 정보 없음',
                price: details ? details.dataset.price : '가격 정보 없음',
                rating: details ? details.dataset.rating : '0',
                material: details ? details.dataset.material : '소재 정보 없음',
                description: details ? details.dataset.description : '설명 없음',
                productLink: details ? details.dataset.productLink : '#',
                site: details ? details.dataset.site : '사이트 정보 없음'
            };
        });

        const tableHtml = `
            <button class="close-button" aria-label="Close modal">
                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-x"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg>
            </button>
            <h2 class="modal-title">상품 비교</h2>
            <table class="comparison-table-modal">
                <thead>
                    <tr>
                        <th></th>
                        ${productsData.map(p => `
                            <th>
                                <img src="${p.img}" alt="${p.name}">
                            </th>
                        `).join('')}
                    </tr>
                </thead>
                <tbody>
                    <tr>
                        <td class="attribute-label">이름</td>
                        ${productsData.map(p => `<td>${p.name}</td>`).join('')}
                    </tr>
                    <tr>
                        <td class="attribute-label">브랜드</td>
                        ${productsData.map(p => `<td>${p.brand || '브랜드 정보 없음'}</td>`).join('')}
                    </tr>
                    <tr>
                        <td class="attribute-label">사이트</td>
                        ${productsData.map(p => `<td>${p.site || '사이트 정보 없음'}</td>`).join('')}
                    </tr>
                    <tr>
                        <td class="attribute-label">가격</td>
                        ${productsData.map(p => `<td class="price-cell">${p.price}</td>`).join('')}
                    </tr>
                </tbody>
            </table>
        `;

        modalContainer.innerHTML = tableHtml;
        modalOverlay.classList.add('visible');

        modalContainer.querySelector('.close-button').addEventListener('click', hideModal);
    }

    function hideModal() {
        modalOverlay.classList.remove('visible');
    }

    compareBtn.addEventListener("click", showModal);

    modalOverlay.addEventListener("click", (e) => {
        if (e.target === modalOverlay) {
            hideModal();
        }
    });

    const selectAllCheckbox = document.getElementById('selectAllCheckbox');
    const deleteSelectedBtn = document.getElementById('deleteSelectedBtn');

    function updateSelectAllCheckbox() {
        const productCheckboxes = document.querySelectorAll('.jjim-product-checkbox');
        const allChecked = Array.from(productCheckboxes).every(checkbox => checkbox.checked);
        selectAllCheckbox.checked = allChecked;
    }

    selectAllCheckbox.addEventListener('change', () => {
        document.querySelectorAll('.jjim-product-checkbox').forEach(checkbox => {
            checkbox.checked = selectAllCheckbox.checked;
        });
    });

    document.addEventListener('change', (e) => {
        if (e.target.classList.contains('jjim-product-checkbox')) {
            updateSelectAllCheckbox();
        }
    });

    deleteSelectedBtn.addEventListener('click', async () => {
        const selectedProductIdsToDelete = Array.from(document.querySelectorAll('.jjim-product-checkbox:checked'))
            .map(checkbox => checkbox.dataset.productId);

        if (selectedProductIdsToDelete.length === 0) {
            alert('삭제할 상품을 선택해주세요.');
            return;
        }

        if (!confirm(`선택된 상품 ${selectedProductIdsToDelete.length}개를 정말 삭제하시겠습니까?`)) {
            return;
        }

        try {
            const formData = new FormData();
            formData.append('product_ids', selectedProductIdsToDelete.join(','));

            const response = await fetch('/jjim/delete', {
                method: 'POST',
                body: formData
            });

            const result = await response.json();

            if (result.success) {
                alert(`${result.deleted_count}개의 상품이 삭제되었습니다.`);
                selectedProductIdsToDelete.forEach(id => {
                    const cardToRemove = document.querySelector(`.jjim-product-card[data-product-id="${id}"]`);
                    if (cardToRemove) {
                        const slotCard = slots.find(slot => slot.querySelector(`.jjim-product-card[data-product-id="${id}"]`));
                        if (slotCard) {
                            slotCard.classList.remove('filled');
                            slotCard.innerHTML = `<span>상품 ${slotCard.dataset.slotId}을 선택하세요</span>`;
                        }
                        cardToRemove.remove();
                        selectedProductIds.delete(id);
                    }
                });
                updateCompareButton();
                selectAllCheckbox.checked = false;
                updateSelectAllCheckbox();
            } else {
                alert(`상품 삭제 실패: ${result.message}`);
            }
        } catch (error) {
            console.error('Error deleting products:', error);
            alert('상품 삭제 중 오류가 발생했습니다.');
        }
    });
});
</script>
{% endblock %}
