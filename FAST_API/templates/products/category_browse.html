{% extends "base.html" %}

{% block head %}
  <link rel="stylesheet" href="{{ url_for('static', path='css/category_browse.css') }}">
  <link rel="stylesheet" href="{{ url_for('static', path='css/filters.css') }}">
{% endblock %}

{% block content %}
<section class="category-page">
  <!-- í•„í„° ì‚¬ì´ë“œë°” -->
  <aside class="filter-sidebar">
    <h2>í•„í„°</h2>

    <!-- ì„±ë³„ í•„í„° -->
    <div class="filter-section">
        <h3>ì„±ë³„</h3>
        <div class="filter-options">
            <label class="filter-option">
                <input type="checkbox" name="gender" value="male" class="filter-checkbox">
                <span class="checkmark"></span>
                ë‚¨ì„±
            </label>
            <label class="filter-option">
                <input type="checkbox" name="gender" value="female" class="filter-checkbox">
                <span class="checkmark"></span>
                ì—¬ì„±
            </label>
            <label class="filter-option">
                <input type="checkbox" name="gender" value="unisex" class="filter-checkbox">
                <span class="checkmark"></span>
                ê³µìš©
            </label>
        </div>
    </div>

    <!-- ì˜ë¥˜ íƒ€ì… í•„í„° -->
    <div class="filter-section">
        <h3>ì˜ë¥˜ íƒ€ì…</h3>
        <div class="filter-options">
            <label class="filter-option">
                <input type="checkbox" name="clothing_type" value="top" class="filter-checkbox">
                <span class="checkmark"></span>
                ìƒì˜
            </label>
            <label class="filter-option">
                <input type="checkbox" name="clothing_type" value="bottom" class="filter-checkbox">
                <span class="checkmark"></span>
                í•˜ì˜
            </label>
            <label class="filter-option">
                <input type="checkbox" name="clothing_type" value="skirt" class="filter-checkbox">
                <span class="checkmark"></span>
                ìŠ¤ì»¤íŠ¸
            </label>
        </div>
    </div>

    <!-- ê°€ê²© í•„í„° -->
    <div class="filter-section">
        <h3>ê°€ê²© ë²”ìœ„</h3>
        <div class="price-filter">
            <div class="price-inputs">
                <input type="number" id="min-price" placeholder="ìµœì†Œê°€ê²©" class="price-input">
                <span class="price-separator">~</span>
                <input type="number" id="max-price" placeholder="ìµœëŒ€ê°€ê²©" class="price-input">
            </div>
            <div class="price-buttons">
                <button class="price-btn" data-min="0" data-max="30000">3ë§Œì› ì´í•˜</button>
                <button class="price-btn" data-min="30000" data-max="50000">3-5ë§Œì›</button>
                <button class="price-btn" data-min="50000" data-max="100000">5-10ë§Œì›</button>
                <button class="price-btn" data-min="100000" data-max="999999">10ë§Œì› ì´ìƒ</button>
            </div>
        </div>
    </div>

    <!-- í•„í„° ì´ˆê¸°í™” -->
    <div class="filter-actions">
        <button id="clear-filters" class="clear-btn">í•„í„° ì´ˆê¸°í™”</button>
        <button id="apply-filters" class="apply-btn">í•„í„° ì ìš©</button>
    </div>
  </aside>

  <!-- ìƒí’ˆ ëª©ë¡ ì„¹ì…˜ -->
  <main class="product-listing-area">
    <div class="listing-header">
        <h1>ìƒí’ˆ ëª©ë¡</h1>
        <div class="sort-options">
            <select id="sort-select" class="sort-select">
                <option value="default">ê¸°ë³¸ìˆœ</option>
                <option value="price-low">ê°€ê²© ë‚®ì€ìˆœ</option>
                <option value="price-high">ê°€ê²© ë†’ì€ìˆœ</option>
                <option value="name">ì´ë¦„ìˆœ</option>
            </select>
        </div>
    </div>

    <!-- ìƒí’ˆ ê·¸ë¦¬ë“œ -->
    <div class="product-grid" id="product-grid">
        {% for product in products %}
        <div class="product-card" 
             data-product-id="{{ product.get('ìƒí’ˆì½”ë“œ', '') }}"
             data-product-name="{{ product.get('ìƒí’ˆëª…', '') }}"
             data-product-brand="{{ product.get('í•œê¸€ë¸Œëœë“œëª…', '') }}"
             data-product-category="{{ product.get('ëŒ€ë¶„ë¥˜', '') }}"
             data-product-subcategory="{{ product.get('ì†Œë¶„ë¥˜', '') }}"
             data-product-color="{{ product.get('ìƒ‰ìƒ', '') }}"
             data-product-price="{{ product.get('ì›ê°€', '0') }}"
             data-product-image="{{ product.get('ì´ë¯¸ì§€URL', '') }}"
             data-product-link="{{ product.get('ìƒí’ˆë§í¬', '') }}"
             data-product-material="{{ product.get('ì†Œì¬', '') }}"
             data-gender="{{ product.get('ì„±ë³„', '') }}"
             data-type="{{ product.get('ëŒ€ë¶„ë¥˜', '') }}">
            <img src="{{ product.get('ì´ë¯¸ì§€URL', '') }}" 
                 alt="{{ product.get('ìƒí’ˆëª…', '') }}"
                 title="{{ product.get('ìƒí’ˆëª…', '') }}: {{ product.get('í•œê¸€ë¸Œëœë“œëª…', '') }}">
        </div>
        {% endfor %}
    </div>

    <!-- ê²°ê³¼ ì—†ìŒ ë©”ì‹œì§€ -->
    <div id="no-results" class="no-results" style="display: none;">
        <p>ì¡°ê±´ì— ë§ëŠ” ìƒí’ˆì´ ì—†ìŠµë‹ˆë‹¤.</p>
    </div>
  </main>
</section>

<!-- ì œí’ˆ ìƒì„¸ ëª¨ë‹¬ -->
<div id="product-modal" class="modal">
  <div class="modal-content">
    <div class="modal-header">
      <h3>ìƒí’ˆ ìƒì„¸ ì •ë³´</h3>
      <button id="close-modal">&times;</button>
    </div>
    <div id="product-details" class="modal-body">
      <!-- ìƒí’ˆ ìƒì„¸ ì •ë³´ê°€ ì—¬ê¸°ì— í‘œì‹œë©ë‹ˆë‹¤ -->
    </div>
  </div>
</div>
{% endblock %}

{% block scripts %}
{{ super() }}
<script src="{{ url_for('static', path='js/filters.js') }}"></script>
<script>
document.addEventListener('DOMContentLoaded', function() {
  // ëª¨ë‹¬ ìš”ì†Œë“¤
  const modal = document.getElementById('product-modal');
  const closeBtn = document.getElementById('close-modal');
  const productDetails = document.getElementById('product-details');

  // ëª¨ë‹¬ ì—´ê¸°/ë‹«ê¸°
  function openModal() {
    modal.style.display = 'flex';
  }

  function closeModal() {
    modal.style.display = 'none';
  }

  // ì œí’ˆ ìƒì„¸ ì •ë³´ ë¡œë“œ
  function loadProductDetails(card) {
    const productId = card.dataset.productId;
    const productName = card.dataset.productName;
    const productBrand = card.dataset.productBrand;
    const productCategory = card.dataset.productCategory;
    const productSubcategory = card.dataset.productSubcategory;
    const productColor = card.dataset.productColor;
    const productPrice = card.dataset.productPrice;
    const productImage = card.dataset.productImage;
    const productLink = card.dataset.productLink;

    // ê°€ê²© í¬ë§·íŒ…
    function formatPrice(price) {
      if (!price || price === '0') return 'N/A';
      return parseInt(price).toLocaleString('ko-KR') + 'ì›';
    }

    productDetails.innerHTML = `
      <div class="product-detail-content">
        <div class="product-image">
          <img src="${productImage}" alt="${productName}">
        </div>
        <div class="product-info">
          <h4>${productName}</h4>
          <div class="product-details">
            <p><strong>ë¸Œëœë“œ:</strong> ${productBrand || 'N/A'}</p>
            <p><strong>ì¹´í…Œê³ ë¦¬:</strong> ${productCategory || 'N/A'} > ${productSubcategory || 'N/A'}</p>
            <p><strong>ìƒ‰ìƒ:</strong> ${productColor || 'N/A'}</p>
            <p><strong>ê°€ê²©:</strong> <span class="price">${formatPrice(productPrice)}</span></p>
          </div>
          <div class="product-actions">
            <a href="${productLink}" target="_blank" class="btn btn-primary">ğŸ”— ë§í¬ë¡œ ì´ë™</a>
            <button onclick="addToJjim('${productId}')" class="btn btn-secondary">â¤ï¸ ì°œëª©ë¡ì— ì¶”ê°€</button>
          </div>
        </div>
      </div>
    `;
  }

  // ì œí’ˆ ì¹´ë“œ í´ë¦­ ì´ë²¤íŠ¸
  document.addEventListener('click', function(e) {
    const card = e.target.closest('.product-card');
    if (card) {
      loadProductDetails(card);
      openModal();
    }
  });

  // ëª¨ë‹¬ ë‹«ê¸° ì´ë²¤íŠ¸
  closeBtn.addEventListener('click', closeModal);
  modal.addEventListener('click', function(e) {
    if (e.target === modal) closeModal();
  });

  // ì°œëª©ë¡ ì¶”ê°€ í•¨ìˆ˜
  window.addToJjim = async function(productId) {
    if (!productId) {
      alert('ìƒí’ˆ IDë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
      return;
    }

    try {
      const formData = new FormData();
      formData.append('product_id', productId);

      const response = await fetch('/preference/jjim', {
        method: 'POST',
        body: formData
      });

      if (response.ok) {
        alert('ì°œëª©ë¡ì— ì¶”ê°€ë˜ì—ˆìŠµë‹ˆë‹¤!');
      } else {
        const result = await response.json();
        if (result.message === 'ì‚¬ìš©ì ì—†ìŒ') {
          alert('ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤.');
        } else {
          alert(`ì°œëª©ë¡ ì¶”ê°€ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤: ${result.message || 'ì•Œ ìˆ˜ ì—†ëŠ” ì˜¤ë¥˜'}`);
        }
      }
    } catch (error) {
      console.error('Error adding to jjim:', error);
      alert('ì°œëª©ë¡ ì¶”ê°€ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
    }
  };

  // í•„í„° ê¸°ëŠ¥ (ê¸°ë³¸ì ì¸ ê²ƒë§Œ)
  document.getElementById('apply-filters').addEventListener('click', function() {
    // í•„í„° ë¡œì§ì€ ë‚˜ì¤‘ì— êµ¬í˜„
    console.log('í•„í„° ì ìš©');
  });

  document.getElementById('clear-filters').addEventListener('click', function() {
    // ëª¨ë“  ì²´í¬ë°•ìŠ¤ í•´ì œ
    document.querySelectorAll('input[type="checkbox"]').forEach(cb => cb.checked = false);
    // ê°€ê²© ì…ë ¥ í•„ë“œ ì´ˆê¸°í™”
    document.getElementById('min-price').value = '';
    document.getElementById('max-price').value = '';
    // ì •ë ¬ ì´ˆê¸°í™”
    document.getElementById('sort-select').value = 'default';
  });
});
</script>
{% endblock %}