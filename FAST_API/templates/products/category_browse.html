{% extends "base.html" %}

{% block head %}
  <link rel="stylesheet" href="{{ url_for('static', path='css/category_browse.css') }}">
  <link rel="stylesheet" href="{{ url_for('static', path='css/category_browse_clean.css') }}">
{% endblock %}

{% block content %}
<section class="category-page">
  <aside class="sidebar">
    <h2>필터</h2>

                </div>
            </div>

            <!-- 의류 타입 필터 -->
            <div class="filter-section">
                <h3>의류 타입</h3>
                <div class="filter-options">
                    <label class="filter-option">
                        <input type="checkbox" name="clothing_type" value="top" class="filter-checkbox">
                        <span class="checkmark"></span>
                        상의
                    </label>
                    <label class="filter-option">
                        <input type="checkbox" name="clothing_type" value="bottom" class="filter-checkbox">
                        <span class="checkmark"></span>
                        하의
                    </label>
                    <label class="filter-option">
                        <input type="checkbox" name="clothing_type" value="skirt" class="filter-checkbox">
                        <span class="checkmark"></span>
                        스커트
                    </label>

                </div>
            </div>

            <!-- 상의 소분류 필터 -->
            <div class="filter-section" id="top-subcategories" style="display: none;">
                <h3>상의 소분류</h3>
                <div class="filter-options">
                    <label class="filter-option">
                        <input type="checkbox" name="top_subcategory" value="tshirt" class="filter-checkbox">
                        <span class="checkmark"></span>
                        티셔츠
                    </label>
                    <label class="filter-option">
                        <input type="checkbox" name="top_subcategory" value="sweatshirt" class="filter-checkbox">
                        <span class="checkmark"></span>
                        맨투맨/후드
                    </label>
                    <label class="filter-option">
                        <input type="checkbox" name="top_subcategory" value="shirt" class="filter-checkbox">
                        <span class="checkmark"></span>
                        셔츠/블라우스
                    </label>
                    <label class="filter-option">
                        <input type="checkbox" name="top_subcategory" value="knit" class="filter-checkbox">
                        <span class="checkmark"></span>
                        니트
                    </label>
                    <label class="filter-option">
                        <input type="checkbox" name="top_subcategory" value="sleeveless" class="filter-checkbox">
                        <span class="checkmark"></span>
                        민소매
                    </label>
                </div>
            </div>

            <!-- 하의 소분류 필터 -->
            <div class="filter-section" id="bottom-subcategories" style="display: none;">
                <h3>하의 소분류</h3>
                <div class="filter-options">
                    <label class="filter-option">
                        <input type="checkbox" name="bottom_subcategory" value="jeans" class="filter-checkbox">
                        <span class="checkmark"></span>
                        청바지
                    </label>
                    <label class="filter-option">
                        <input type="checkbox" name="bottom_subcategory" value="pants" class="filter-checkbox">
                        <span class="checkmark"></span>
                        팬츠
                    </label>
                    <label class="filter-option">
                        <input type="checkbox" name="bottom_subcategory" value="shorts" class="filter-checkbox">
                        <span class="checkmark"></span>
                        반바지
                    </label>
                    <label class="filter-option">
                        <input type="checkbox" name="bottom_subcategory" value="leggings" class="filter-checkbox">
                        <span class="checkmark"></span>
                        레깅스
                    </label>
                    <label class="filter-option">
                        <input type="checkbox" name="bottom_subcategory" value="joggers" class="filter-checkbox">
                        <span class="checkmark"></span>
                        조거팬츠
                    </label>
                </div>
            </div>

            <!-- 스커트 소분류 필터 -->
            <div class="filter-section" id="skirt-subcategories" style="display: none;">
                <h3>스커트 소분류</h3>
                <div class="filter-options">
                    <label class="filter-option">
                        <input type="checkbox" name="skirt_subcategory" value="mini" class="filter-checkbox">
                        <span class="checkmark"></span>
                        미니스커트
                    </label>
                    <label class="filter-option">
                        <input type="checkbox" name="skirt_subcategory" value="midi" class="filter-checkbox">
                        <span class="checkmark"></span>
                        미디스커트
                    </label>
                    <label class="filter-option">
                        <input type="checkbox" name="skirt_subcategory" value="maxi" class="filter-checkbox">
                        <span class="checkmark"></span>
                        맥시스커트
                    </label>
                    <label class="filter-option">
                        <input type="checkbox" name="skirt_subcategory" value="pleated" class="filter-checkbox">
                        <span class="checkmark"></span>
                        플리츠스커트
                    </label>
                    <label class="filter-option">
                        <input type="checkbox" name="skirt_subcategory" value="a_line" class="filter-checkbox">
                        <span class="checkmark"></span>
                        A라인스커트
                    </label>
                </div>
            </div>

            <!-- 가격 필터 -->
            <div class="filter-section">
                <h3>가격 범위</h3>
                <div class="price-filter">
                    <div class="price-inputs">
                        <input type="number" id="min-price" placeholder="최소가격" class="price-input">
                        <span class="price-separator">~</span>
                        <input type="number" id="max-price" placeholder="최대가격" class="price-input">
                    </div>
                    <div class="price-buttons">
                        <button class="price-btn" data-min="0" data-max="30000">3만원 이하</button>
                        <button class="price-btn" data-min="30000" data-max="50000">3-5만원</button>
                        <button class="price-btn" data-min="50000" data-max="100000">5-10만원</button>
                        <button class="price-btn" data-min="100000" data-max="999999">10만원 이상</button>
                    </div>
                </div>
            </div>

            <!-- 평점 필터 -->
            <div class="filter-section">
                <h3>평점</h3>
                <div class="rating-filter">
                    <div class="rating-inputs">
                        <input type="number" id="min-rating" placeholder="최소" min="0" max="5" step="0.1" class="rating-input">
                        <span class="rating-separator">~</span>
                        <input type="number" id="max-rating" placeholder="최대" min="0" max="5" step="0.1" class="rating-input">
                    </div>
                    <div class="rating-buttons">
                        <button type="button" class="rating-btn" data-min="4.0" data-max="5.0">4.0점 이상</button>
                        <button type="button" class="rating-btn" data-min="3.0" data-max="5.0">3.0점 이상</button>
                        <button type="button" class="rating-btn" data-min="2.0" data-max="5.0">2.0점 이상</button>
                        <button type="button" class="rating-btn" data-min="0" data-max="5.0">전체</button>
                    </div>
                </div>
            </div>

            <!-- 브랜드 필터 -->
            <div class="filter-section">
                <h3>브랜드</h3>
                <div class="brand-search">
                    <input type="text" id="brand-search" placeholder="브랜드명을 입력하세요 (쉼표로 구분)" class="brand-input">
                </div>
            </div>

            <!-- 필터 초기화 -->
            <div class="filter-actions">
                <button id="clear-filters" class="clear-btn">필터 초기화</button>
                <button id="apply-filters" class="apply-btn">필터 적용</button>
            </div>
        </aside>

        <main class="product-listing-area">
            <div class="listing-header">
                <h1>상품 목록</h1>
                <div class="sort-options">
                    <select id="sort-select" class="sort-select">
                        <option value="default">기본순</option>
                        <option value="price-low">가격 낮은순</option>
                        <option value="price-high">가격 높은순</option>
                        <option value="rating">평점순</option>
                        <option value="name">이름순</option>
                    </select>
                </div>
            </div>
            
            <div class="active-filters" id="active-filters">
                <!-- 활성화된 필터들이 여기에 표시됩니다 -->
            </div>

                <div class="product-grid" id="product-grid">
                {% for product in products %}
                <div class="product-card" 
                     data-gender="{{ product.get('성별', '') }}" data-gender-key="{{ product.get('gender_key','') }}"
                     data-type="{{ product.get('의류타입', '') }}" data-type-key="{{ product.get('type_key','') }}"
                     data-subcategory="{{ product.get('소분류', '') }}" data-subcat-key="{{ product.get('subcat_key','') }}"
                     data-price="{{ product.get('processed_price', '0') }}"
                     data-rating="{{ product.get('평점', '') }}"
                     data-brand="{{ product.get('브랜드', '') }}">
                    <img src="{{ product.get('대표이미지URL') or product.get('사진') }}" alt="{{ product['상품명'] }}">
                    <div class="product-card-content">
                        <h3>{{ product['상품명'] }}</h3>
                        <p class="brand">{{ product.get('브랜드', '') }}</p>
                        <p class="price">{{ product['가격'] }}</p>
                        <div class="rating">
                            <span class="stars" data-rating="{{ product.get('평점', '0') }}">
                                {% set rating = product.get('평점', 0) | float %}
                                {% for i in range(5) %}
                                    {% if rating >= i + 0.5 %}
                                        ★
                                    {% else %}
                                        ☆
                                    {% endif %}
                                {% endfor %}
                            </span>
                            <span class="rating-text">{{ product.get('평점', '0') }}/5</span>
                        </div>
                        <button class="add-to-cart">장바구니에 추가</button>
                    </div>
                </div>
                {% endfor %}
            </div>

            <div class="no-results" id="no-results" style="display: none;">
                <p>조건에 맞는 상품이 없습니다.</p>
                <button onclick="clearAllFilters()" class="clear-all-btn">모든 필터 초기화</button>
            </div>
            
            <div class="load-more-container" id="load-more-container" style="display: none;">
                <button id="load-more-btn" class="load-more-btn">더 많은 상품 보기</button>
            </div>
        </main>
    <div class="filter-group">
      <h3>성별</h3>
      <label class="filter-option"><input class="filter-checkbox" type="checkbox" value="남성" data-filter="gender"> 남성</label>
      <label class="filter-option"><input class="filter-checkbox" type="checkbox" value="여성" data-filter="gender"> 여성</label>
      <label class="filter-option"><input class="filter-checkbox" type="checkbox" value="공용" data-filter="gender"> 공용</label>
    </div>

    <div class="filter-group">
      <h3>의류 타입</h3>
      <label class="filter-option"><input class="filter-checkbox" type="checkbox" value="상의" data-filter="type"> 상의</label>
      <label class="filter-option"><input class="filter-checkbox" type="checkbox" value="하의" data-filter="type"> 하의</label>
      <label class="filter-option"><input class="filter-checkbox" type="checkbox" value="아우터" data-filter="type"> 아우터</label>
      <label class="filter-option"><input class="filter-checkbox" type="checkbox" value="원피스" data-filter="type"> 원피스</label>
    </div>

    <div class="filter-group">
      <h3>브랜드</h3>
      <input id="brand-search" type="text" placeholder="브랜드 검색" />
    </div>

    <div class="filter-group">
      <h3>가격</h3>
      <input id="price-min" type="number" placeholder="최소" min="0" />
      <input id="price-max" type="number" placeholder="최대" min="0" />
    </div>

    <div class="filter-group">
      <h3>평점</h3>
      <label class="filter-option"><input class="filter-checkbox" type="checkbox" value="4" data-filter="rating"> 4.0+</label>
      <label class="filter-option"><input class="filter-checkbox" type="checkbox" value="3" data-filter="rating"> 3.0+</label>
    </div>
  </aside>

  <main class="listing">
    <header class="listing-header">
      <div class="top-actions">
        <div class="meta">총 <strong id="result-total">0</strong> 개</div>
        <div class="view-toggle">
          <button type="button" class="active" data-view="grid">Grid</button>
          <button type="button" data-view="compact">Compact</button>
        </div>
        <select id="sort-select" class="sort-select" aria-label="정렬">
          <option value="relevance">추천순</option>
          <option value="price_asc">가격 낮은순</option>
          <option value="price_desc">가격 높은순</option>
          <option value="rating_desc">평점 높은순</option>
        </select>
      </div>

      <div id="active-filters" class="active-filters"></div>
    </header>

    <div id="product-grid" class="product-grid">
      {# 서버에서 넘겨준 products를 카드로 뿌립니다 #}
      {% for product in products %}
      <article class="product-card" 
               data-gender="{{ product.gender }}" 
               data-type="{{ product.type }}"
               data-price="{{ product.price }}"
               data-rating="{{ product.rating|default(0) }}"
               data-brand="{{ product.brand|default('') }}">
        <img src="{{ product.image_url }}" alt="{{ product.name }} 이미지" loading="lazy" />
        <div class="card-content">
          <h4 class="name">{{ product.name }}</h4>
          <div class="brand">{{ product.brand }}</div>
          <div class="price">{{ product.price_formatted }}</div>
          <div class="stars" aria-label="rating">
            {% set rating = product.rating|default(0) %}
            {% for i in range(1, 6) %}
              {% if rating >= i %}
                <span class="star full">★</span>
              {% elif rating >= i - 0.5 %}
                <span class="star half">★</span>
              {% else %}
                <span class="star">☆</span>
              {% endif %}
            {% endfor %}
            <span class="rating-num">{{ "%.1f"|format(rating) }}</span>
          </div>
        </div>
        <div class="card-badges">
          <span class="badge gender-badge">{{ product.gender }}</span>
          <span class="badge type-badge">{{ product.type }}</span>
        </div>
      </article>
      {% endfor %}
    </div>

    <div class="load-more">
      <button id="load-more" class="load-more-btn" type="button">더 보기</button>
    </div>
  </main>
</section>
{% endblock %}

{% block scripts %}
{{ super() }}
<script>
// 최소한의 UI 보조 스크립트 (필터 칩/카운트/뷰 토글) — API 로직은 건드리지 않음
document.addEventListener('DOMContentLoaded', function(){
  var grid = document.getElementById('product-grid');
  var total = document.getElementById('result-total');
  var chipsWrap = document.getElementById('active-filters');
  var viewBtns = document.querySelectorAll('.view-toggle button');
  var loadMoreBtn = document.getElementById('load-more');

  function updateCount(){
    if (!total) return;
    var visible = Array.from(document.querySelectorAll('.product-card'))
      .filter(function(c){ return c.offsetParent !== null; }).length;
    total.textContent = String(visible);
  }

  function rebuildChips(){
    if (!chipsWrap) return;
    chipsWrap.innerHTML = '';
    var checked = document.querySelectorAll('.filter-checkbox:checked');
    checked.forEach(function(chk){
      var label = chk.closest('.filter-option');
      var text = label ? label.textContent.trim() : chk.value;
      var chip = document.createElement('span');
      chip.className = 'filter-chip';
      chip.innerHTML = text + '<button aria-label="remove">×</button>';
      chip.querySelector('button').addEventListener('click', function(){
        chk.checked = false;
        chk.dispatchEvent(new Event('change', {bubbles:true}));
      });
      chipsWrap.appendChild(chip);
    });
    var brand = document.getElementById('brand-search');
    if (brand && brand.value.trim()){
      var chip = document.createElement('span');
      chip.className = 'filter-chip';
      chip.innerHTML = '브랜드: ' + brand.value + '<button aria-label="remove">×</button>';
      chip.querySelector('button').addEventListener('click', function(){
        brand.value='';
        brand.dispatchEvent(new Event('input'));
      });
      chipsWrap.appendChild(chip);
    }
  }

  function refreshUI(){
    updateCount();
    rebuildChips();
  }

  // View toggle
  viewBtns.forEach(function(btn){
    btn.addEventListener('click', function(){
      viewBtns.forEach(function(b){ b.classList.remove('active'); });
      btn.classList.add('active');
      if (btn.dataset.view === 'compact'){
        grid.style.gridTemplateColumns = 'repeat(auto-fill, minmax(220px, 1fr))';
      } else {
        grid.style.gridTemplateColumns = '';
      }
    });
  });

  // Observe typical filter elements; 실제 필터링/정렬은 기존 JS 또는 서버가 담당
  document.body.addEventListener('change', function(e){
    if (e.target.matches('.filter-checkbox')) setTimeout(refreshUI, 30);
  });
  var brand = document.getElementById('brand-search');
  if (brand) brand.addEventListener('input', function(){ setTimeout(refreshUI, 30); });

  // "더 보기" 버튼은 기존 로직이 있으면 그대로 사용
  if (loadMoreBtn){
    loadMoreBtn.addEventListener('click', function(){
      // 프론트 전용일 경우에만: 단순히 다음 카드들 display 처리
      // 서버/JS 로드 로직이 있으면 해당 함수 호출로 대체
      refreshUI();
    });
  }

  refreshUI();
});
</script>
{% endblock %}
